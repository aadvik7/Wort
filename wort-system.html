<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wort — Logistics Management</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f6fa;--white:#fff;--border:#e6e8ef;--bl:#f0f1f6;
  --text:#0f1523;--t2:#4a5068;--t3:#8c93a8;
  --accent:#1a56db;--ad:#eff4ff;--ab:#bfcefa;
  --green:#0d9f6e;--gd:#ecfdf5;--gb:#6ee7b7;
  --amber:#c27803;--amd:#fffbeb;--amb:#fde68a;
  --red:#e02424;--rd:#fef2f2;--rb:#fecaca;
  --violet:#7e3af2;--vd:#f5f3ff;--vb:#ddd6fe;
  --teal:#0694a2;--td2:#ecfeff;
  --orange:#ea580c;--od:#fff7ed;--ob:#fed7aa;
  --s1:0 1px 3px rgba(0,0,0,.05),0 1px 2px rgba(0,0,0,.04);
  --s2:0 4px 14px rgba(0,0,0,.08);--s3:0 8px 30px rgba(0,0,0,.1);
  --r:10px;--rs:7px
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px}
#loading-screen{position:fixed;inset:0;background:var(--white);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:.62rem}
.spin{width:22px;height:22px;border:2.5px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#login-screen{min-height:100vh;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,#eef3ff,#fafbff 55%,#f4f5fa)}
.lw{width:435px}
.lh{text-align:center;margin-bottom:1.6rem}
.ll{font-size:1.85rem;font-weight:800;letter-spacing:-.4px}
.ll span{color:var(--accent)}
.ls{font-size:.74rem;color:var(--t3);font-family:'JetBrains Mono',monospace}
.lc{background:var(--white);border:1px solid var(--border);border-radius:14px;padding:1.8rem;box-shadow:var(--s2)}
.lbl{display:block;font-size:.66rem;font-weight:700;letter-spacing:.7px;text-transform:uppercase;color:var(--t2);margin-bottom:.38rem}
.rg{display:grid;grid-template-columns:1fr 1fr;gap:.52rem;margin-bottom:1.1rem}
.rb{border:1.5px solid var(--border);border-radius:var(--rs);padding:.82rem;cursor:pointer;transition:all .14s;background:var(--white)}
.rb:hover,.rb.sel{border-color:var(--accent);background:var(--ad)}
.rb-ico{width:26px;height:26px;border-radius:6px;background:var(--bg);display:flex;align-items:center;justify-content:center;margin-bottom:.36rem}
.rb-ico svg{width:13px;height:13px;stroke:var(--t2);stroke-width:2;fill:none}
.rb.sel .rb-ico{background:var(--accent)}
.rb.sel .rb-ico svg{stroke:#fff}
.rb-name{font-size:.8rem;font-weight:700}
.rb-desc{font-size:.66rem;color:var(--t3)}
.inp{width:100%;background:var(--white);border:1.5px solid var(--border);border-radius:var(--rs);padding:.6rem .85rem;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.84rem;outline:none;transition:border-color .14s;margin-bottom:.68rem}
.inp:focus{border-color:var(--accent)}
.inp::placeholder{color:var(--t3)}
select.inp option{background:var(--white)}
textarea.inp{resize:vertical;min-height:68px;margin-bottom:0}
.btn-enter{width:100%;padding:.68rem;background:var(--accent);color:#fff;border:none;border-radius:var(--rs);font-family:'Plus Jakarta Sans',sans-serif;font-size:.86rem;font-weight:700;cursor:pointer;transition:all .14s}
.btn-enter:hover:not(:disabled){background:#1447c4}
.btn-enter:disabled{opacity:.6;cursor:not-allowed}
.as{text-align:center;margin-top:.78rem;font-size:.76rem;color:var(--t3)}
.as a{color:var(--accent);cursor:pointer;font-weight:600;text-decoration:none}
#app-shell{display:none;flex-direction:row;min-height:100vh}
.sidebar{width:210px;flex-shrink:0;background:var(--white);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
.sb-top{padding:1.05rem 1.05rem .65rem;border-bottom:1px solid var(--bl)}
.sb-logo{font-size:1.18rem;font-weight:800;letter-spacing:-.3px}
.sb-logo span{color:var(--accent)}
.sb-tag{display:inline-block;margin-top:.18rem;font-size:.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--accent);background:var(--ad);border:1px solid var(--ab);padding:.08rem .38rem;border-radius:4px}
.sb-nav{flex:1;padding:.45rem 0;overflow-y:auto}
.sb-sec{padding:.5rem 1.05rem .16rem;font-size:.57rem;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--t3)}
.sb-item{display:flex;align-items:center;gap:.48rem;padding:.46rem 1.05rem;font-size:.79rem;font-weight:500;color:var(--t2);cursor:pointer;transition:all .1s;border-left:2px solid transparent;position:relative}
.sb-item:hover{background:var(--bg);color:var(--text)}
.sb-item.active{color:var(--accent);background:var(--ad);font-weight:600;border-left-color:var(--accent)}
.sb-ico{width:14px;height:14px;flex-shrink:0}
.sb-ico svg{width:100%;height:100%;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.n-dot{width:6px;height:6px;background:var(--red);border-radius:50%;margin-left:auto;animation:pulse 2s infinite}
.n-cnt{min-width:16px;height:16px;background:var(--red);border-radius:8px;margin-left:auto;font-size:.58rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 .25rem}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.sb-bot{padding:.75rem 1.05rem;border-top:1px solid var(--border)}
.sb-ur{display:flex;align-items:center;gap:.48rem;margin-bottom:.45rem}
.av{width:26px;height:26px;background:var(--ad);border:1px solid var(--ab);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:800;color:var(--accent);flex-shrink:0;font-family:'JetBrains Mono',monospace}
.sb-un{font-size:.75rem;font-weight:700}
.sb-ur2{font-size:.62rem;color:var(--t3)}
.so{width:100%;padding:.33rem .58rem;background:transparent;border:1px solid var(--border);border-radius:5px;color:var(--t3);font-size:.71rem;font-family:'Plus Jakarta Sans',sans-serif;cursor:pointer;transition:all .1s}
.so:hover{border-color:var(--red);color:var(--red)}
.main{margin-left:210px;flex:1;display:flex;flex-direction:column}
.topbar{background:var(--white);border-bottom:1px solid var(--border);padding:0 1.6rem;height:50px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:30}
.tb-t{font-size:.88rem;font-weight:700}
.tb-s{font-size:.72rem;color:var(--t3);margin-left:.5rem}
.tb-r{display:flex;align-items:center;gap:.38rem}
.pb{padding:1.35rem 1.6rem;flex:1}
.btn{display:inline-flex;align-items:center;gap:.24rem;padding:.42rem .82rem;border-radius:var(--rs);font-family:'Plus Jakarta Sans',sans-serif;font-size:.77rem;font-weight:600;cursor:pointer;transition:all .13s;border:none;white-space:nowrap}
.btn-blue{background:var(--accent);color:#fff}
.btn-blue:hover{background:#1447c4}
.btn-outline{background:var(--white);color:var(--t2);border:1.5px solid var(--border)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-ghost{background:transparent;color:var(--t2)}
.btn-ghost:hover{background:var(--bg)}
.btn-green{background:var(--gd);color:var(--green);border:1px solid var(--gb)}
.btn-green:hover{background:var(--green);color:#fff}
.btn-red{background:var(--rd);color:var(--red);border:1px solid var(--rb)}
.btn-red:hover{background:var(--red);color:#fff}
.btn-amber{background:var(--amd);color:var(--amber);border:1px solid var(--amb)}
.btn-sm{padding:.28rem .58rem;font-size:.72rem}
.bi{width:26px;height:26px;padding:0;border-radius:5px;background:transparent;border:1px solid var(--border);color:var(--t3);display:flex;align-items:center;justify-content:center;font-size:.72rem;cursor:pointer;transition:all .1s}
.bi:hover{border-color:var(--accent);color:var(--accent);background:var(--ad)}
.bi.del:hover{border-color:var(--red);color:var(--red);background:var(--rd)}
.bi.wa:hover{border-color:#22c55e;color:#22c55e;background:#f0fdf4}
.bi.cal:hover{border-color:var(--violet);color:var(--violet);background:var(--vd)}
.ab{display:flex;gap:.2rem}
.sg{display:grid;grid-template-columns:repeat(4,1fr);gap:.85rem;margin-bottom:1.35rem}
.sc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:1rem;box-shadow:var(--s1)}
.sc-top{margin-bottom:.65rem}
.sc-ico{width:31px;height:31px;border-radius:8px;display:flex;align-items:center;justify-content:center}
.sc-ico svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round}
.sc-v{font-size:1.65rem;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:-.4px;line-height:1;margin-bottom:.12rem}
.sc-l{font-size:.69rem;color:var(--t3);font-weight:500}
.tc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--s1);overflow:hidden;margin-bottom:1.1rem}
.tc-h{padding:.78rem 1.1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:.55rem;flex-wrap:wrap}
.tc-t{font-size:.84rem;font-weight:700}
.tc-a{display:flex;gap:.35rem;align-items:center}
.srch{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rs);padding:.36rem .6rem;font-size:.74rem;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text);outline:none;width:160px;transition:border-color .13s}
.srch:focus{border-color:var(--accent);background:var(--white)}
.srch::placeholder{color:var(--t3)}
.fsel{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rs);padding:.36rem .52rem;font-size:.72rem;font-family:'Plus Jakarta Sans',sans-serif;color:var(--t2);outline:none;cursor:pointer}
.ts{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead tr{border-bottom:1px solid var(--border)}
th{padding:.5rem .82rem;text-align:left;font-size:.61rem;font-weight:700;letter-spacing:.7px;text-transform:uppercase;color:var(--t3);white-space:nowrap;background:var(--bg)}
td{padding:.72rem .82rem;font-size:.78rem;border-bottom:1px solid var(--bl);vertical-align:middle}
tbody tr{transition:background .1s}
tbody tr:hover{background:#fafbff}
tbody tr:last-child td{border:none}
.mono{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--accent);font-weight:600}
.bdg{display:inline-flex;align-items:center;gap:.2rem;padding:.13rem .44rem;border-radius:20px;font-size:.64rem;font-weight:600;white-space:nowrap}
.bdg::before{content:'';width:4px;height:4px;border-radius:50%;background:currentColor;flex-shrink:0}
.bs{background:var(--ad);color:var(--accent);border:1px solid var(--ab)}
.bq{background:var(--amd);color:var(--amber);border:1px solid var(--amb)}
.ba{background:var(--vd);color:var(--violet);border:1px solid var(--vb)}
.bc{background:var(--gd);color:var(--green);border:1px solid var(--gb)}
.bl{background:var(--rd);color:var(--red);border:1px solid var(--rb)}
.bair{background:var(--vd);color:var(--violet);border:1px solid var(--vb)}
.bsea{background:var(--td2);color:var(--teal);border:1px solid #a5f3fc}
.broad{background:var(--amd);color:var(--amber);border:1px solid var(--amb)}
.bmulti{background:var(--gd);color:var(--green);border:1px solid var(--gb)}
.chip{display:inline-flex;align-items:center;background:var(--gd);border:1px solid var(--gb);color:var(--green);padding:.11rem .38rem;border-radius:4px;font-size:.62rem;font-weight:600;margin-right:.18rem}
.chip-wait{background:var(--od);border-color:var(--ob);color:var(--orange)}
.chip-view{background:var(--ad);border-color:var(--ab);color:var(--accent)}
.cr{display:grid;grid-template-columns:1.2fr 1fr;gap:.85rem;margin-bottom:1.1rem}
.cc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:1rem;box-shadow:var(--s1)}
.cc-t{font-size:.68rem;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.78rem}
.brl{display:flex;flex-direction:column;gap:.44rem}
.br{display:flex;align-items:center;gap:.55rem}
.br-l{font-size:.69rem;color:var(--t2);width:95px;flex-shrink:0;font-weight:500}
.brt{flex:1;height:5px;background:var(--bg);border-radius:100px;overflow:hidden}
.brf{height:100%;border-radius:100px;transition:width .7s cubic-bezier(.4,0,.2,1)}
.br-n{font-size:.66rem;font-family:'JetBrains Mono',monospace;color:var(--t3);width:16px;text-align:right}
.dw{display:flex;align-items:center;gap:1.05rem}
.dsvg{width:100px;height:100px;flex-shrink:0}
.leg{display:flex;flex-direction:column;gap:.34rem}
.leg-r{display:flex;align-items:center;gap:.34rem}
.leg-d{width:6px;height:6px;border-radius:2px;flex-shrink:0}
.leg-l{font-size:.68rem;color:var(--t2);flex:1}
.leg-v{font-size:.66rem;font-family:'JetBrains Mono',monospace;font-weight:600}
.pg{display:grid;grid-template-columns:repeat(3,1fr);gap:.85rem}
.pc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:1rem;box-shadow:var(--s1)}
.pc-top{display:flex;align-items:center;gap:.52rem;margin-bottom:.75rem;padding-bottom:.75rem;border-bottom:1px solid var(--bl)}
.pc-name{font-size:.8rem;font-weight:700}
.pc-role{font-size:.62rem;color:var(--t3)}
.pc-nums{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.35rem;margin-bottom:.72rem}
.pn{text-align:center;background:var(--bg);border-radius:5px;padding:.38rem .14rem}
.pn-v{font-size:.88rem;font-weight:800;font-family:'JetBrains Mono',monospace}
.pn-l{font-size:.57rem;color:var(--t3);text-transform:uppercase}
.pw{margin-bottom:.28rem}
.pw-h{display:flex;justify-content:space-between;margin-bottom:.16rem}
.pw-t{height:4px;background:var(--bg);border-radius:100px;overflow:hidden}
.pw-f{height:100%;border-radius:100px;background:var(--accent);transition:width .7s}
.ov{position:fixed;inset:0;background:rgba(15,21,35,.32);backdrop-filter:blur(3px);z-index:200;display:none;align-items:flex-start;justify-content:center;padding:2.2rem 1rem;overflow-y:auto}
.ov.open{display:flex}
.modal{background:var(--white);border:1px solid var(--border);border-radius:12px;width:100%;max-width:550px;box-shadow:var(--s3);margin:auto}
.mlg{max-width:680px}
.mh{padding:.88rem 1.28rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--white);z-index:1;border-radius:12px 12px 0 0}
.mh-t{font-size:.86rem;font-weight:700}
.mh-x{width:23px;height:23px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:all .1s}
.mh-x:hover{border-color:var(--red);color:var(--red)}
.mb{padding:1.28rem}
.mf{padding:.72rem 1.28rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:.35rem;border-radius:0 0 12px 12px}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:.78rem}
.full{grid-column:1/-1}
.fl{display:flex;flex-direction:column;gap:.22rem}
.sec-lbl{font-size:.7rem;font-weight:700;color:var(--t2);margin:.95rem 0 .45rem;display:flex;align-items:center;gap:.35rem}
.sec-lbl::after{content:'';flex:1;height:1px;background:var(--border)}
.dg{display:grid;grid-template-columns:1fr 1fr;gap:.78rem;margin-bottom:.82rem}
.db{background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);padding:.82rem}
.df{margin-bottom:.52rem}
.df:last-child{margin-bottom:0}
.dk{font-size:.6rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--t3);margin-bottom:.13rem}
.dv{font-size:.78rem;font-weight:500}
.qi{background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);padding:.68rem .82rem;margin-bottom:.38rem}
.qi-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.18rem}
.qi-p{font-size:.88rem;font-weight:800;color:var(--accent);font-family:'JetBrains Mono',monospace}
.qi-m{font-size:.65rem;color:var(--t3)}
.notif-list{display:flex;flex-direction:column;gap:.48rem}
.nc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:.78rem .9rem;display:flex;align-items:flex-start;gap:.62rem;box-shadow:var(--s1)}
.nc.urgent{border-color:var(--amb)}
.ni{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ni svg{width:13px;height:13px;stroke:currentColor;fill:none}
.ni-amber{background:var(--amd)}
.ni-blue{background:var(--ad)}
.nb{flex:1}
.nb-t{font-size:.77rem;font-weight:700;margin-bottom:.14rem}
.nb-m{font-size:.67rem;color:var(--t3);line-height:1.5}
.nb-a{display:flex;gap:.32rem;margin-top:.42rem}
.inv-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.45rem;margin-top:.48rem}
.inv-card{border:1.5px solid var(--border);border-radius:var(--rs);padding:.62rem;cursor:pointer;transition:all .13s;text-align:center;position:relative}
.inv-card:hover{border-color:var(--accent);background:var(--ad)}
.inv-card.sel{border-color:var(--green);background:var(--gd)}
.inv-card.sel .ic-n{color:var(--green)}
.inv-chk{position:absolute;top:.25rem;right:.25rem;width:12px;height:12px;background:var(--green);border-radius:50%;display:none;align-items:center;justify-content:center}
.inv-card.sel .inv-chk{display:flex}
.inv-chk svg{width:7px;height:7px;stroke:#fff}
.ic-av{width:24px;height:24px;border-radius:5px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.68rem;font-family:'JetBrains Mono',monospace;margin:0 auto .28rem}
.ic-n{font-size:.7rem;font-weight:700}
.ic-r{font-size:.6rem;color:var(--t3)}
.share-box{background:linear-gradient(135deg,var(--ad),#eef9ff);border:1.5px solid var(--ab);border-radius:var(--r);padding:.82rem;margin-bottom:.78rem}
.share-inp{flex:1;background:var(--white);border:1px solid var(--border);border-radius:5px;padding:.3rem .58rem;font-size:.67rem;font-family:'JetBrains Mono',monospace;color:var(--t2);outline:none}
.collab-chip{display:flex;align-items:center;gap:.3rem;background:var(--gd);border:1px solid var(--gb);border-radius:5px;padding:.25rem .52rem}
.collab-chip span{font-size:.72rem;font-weight:600;color:var(--green)}
.rc-x{margin-left:auto;font-size:.62rem;color:var(--red);background:none;border:none;cursor:pointer;padding:0 .1rem}
.ban{border-radius:var(--rs);padding:.62rem .82rem;font-size:.73rem;margin-bottom:.82rem;display:flex;align-items:center;justify-content:space-between;gap:.45rem}
.ban-amber{background:var(--amd);border:1px solid var(--amb);color:var(--amber)}
.ban-blue{background:var(--ad);border:1px solid var(--ab);color:var(--accent)}
.ban-green{background:var(--gd);border:1px solid var(--gb);color:var(--green)}
.ban-red{background:var(--rd);border:1px solid var(--rb);color:var(--red)}
.empty{padding:2.2rem;text-align:center;font-size:.78rem;color:var(--t3)}
.page{display:none}
.page.active{display:block}
.toast{position:fixed;bottom:1.25rem;right:1.25rem;background:var(--white);border:1px solid var(--border);border-radius:8px;padding:.58rem .82rem;display:flex;align-items:center;gap:.45rem;z-index:9999;box-shadow:var(--s3);transform:translateY(50px);opacity:0;transition:all .19s;max-width:300px}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{border-left:3px solid var(--green)}
.toast.err{border-left:3px solid var(--red)}
.toast.info{border-left:3px solid var(--accent)}
.toast.warn{border-left:3px solid var(--amber)}
.tdot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.toast.ok .tdot{background:var(--green)}
.toast.err .tdot{background:var(--red)}
.toast.info .tdot{background:var(--accent)}
.toast.warn .tdot{background:var(--amber)}
.tm{font-size:.75rem;font-weight:500}

/* ── AUTO-SUGGEST DROPDOWN ── */
.suggest-wrap{position:relative}
.suggest-drop{
  position:absolute;top:calc(100% + 3px);left:0;right:0;
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--rs);box-shadow:var(--s2);
  z-index:500;max-height:200px;overflow-y:auto;display:none;
}
.suggest-drop.open{display:block}
.sg-item{padding:.55rem .82rem;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bl)}
.sg-item:last-child{border:none}
.sg-item:hover{background:var(--ad);color:var(--accent)}
.sg-item-name{font-weight:600}
.sg-item-meta{font-size:.65rem;color:var(--t3)}
.sg-item-count{font-family:'JetBrains Mono',monospace;font-size:.62rem;background:var(--ad);color:var(--accent);padding:.08rem .3rem;border-radius:4px}

/* ── DUPLICATE WARNING BANNER ── */
.dup-warn{
  display:none;background:var(--amd);border:1.5px solid var(--amb);
  border-radius:var(--rs);padding:.55rem .75rem;margin-bottom:.6rem;
  font-size:.76rem;color:var(--amber);
  align-items:center;justify-content:space-between;gap:.5rem;
}
.dup-warn.show{display:flex}
.dup-warn button{background:var(--amber);color:#fff;border:none;border-radius:4px;padding:.25rem .6rem;font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap}

/* ── STAGNANT ALERT WIDGET ── */
.stagnant-widget{
  background:var(--white);border:1.5px solid var(--amb);
  border-radius:var(--r);padding:1rem;box-shadow:var(--s1);
  margin-bottom:1.1rem;
}
.sw-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem}
.sw-title{font-size:.78rem;font-weight:700;color:var(--amber);display:flex;align-items:center;gap:.38rem}
.stag-row{display:flex;align-items:center;justify-content:space-between;padding:.48rem .65rem;background:var(--amd);border:1px solid var(--amb);border-radius:var(--rs);margin-bottom:.32rem;font-size:.75rem}
.stag-info{flex:1}
.stag-name{font-weight:600}
.stag-meta{font-size:.63rem;color:var(--t3)}
.stag-actions{display:flex;gap:.28rem}

/* ── KANBAN VIEW ── */
#page-kanban{display:none}
#page-kanban.active{display:block}
.kanban-board{display:grid;grid-template-columns:repeat(5,1fr);gap:.85rem;overflow-x:auto;padding-bottom:1rem}
.kb-col{background:var(--bg);border-radius:var(--r);padding:.65rem;min-height:400px}
.kb-col-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.65rem;padding-bottom:.5rem;border-bottom:1px solid var(--border)}
.kb-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px}
.kb-cnt{font-family:'JetBrains Mono',monospace;font-size:.65rem;background:var(--white);border:1px solid var(--border);padding:.06rem .3rem;border-radius:4px;color:var(--t3)}
.kb-card{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--rs);padding:.75rem;margin-bottom:.52rem;
  cursor:grab;transition:all .15s;
  box-shadow:var(--s1);
}
.kb-card:hover{border-color:var(--accent);box-shadow:var(--s2);transform:translateY(-1px)}
.kb-card.dragging{opacity:.5;cursor:grabbing}
.kb-card.drag-over{border-color:var(--accent);background:var(--ad)}
.kb-client{font-size:.8rem;font-weight:700;margin-bottom:.22rem}
.kb-route{font-size:.65rem;color:var(--t3);margin-bottom:.38rem}
.kb-foot{display:flex;align-items:center;justify-content:space-between}
.kb-val{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--accent);font-weight:600}
.kb-owner{font-size:.6rem;color:var(--t3)}
.kb-col[data-status="Submitted"] .kb-col-head .kb-title{color:var(--accent)}
.kb-col[data-status="Quoted"] .kb-col-head .kb-title{color:var(--amber)}
.kb-col[data-status="Accepted"] .kb-col-head .kb-title{color:var(--violet)}
.kb-col[data-status="Completed"] .kb-col-head .kb-title{color:var(--green)}
.kb-col[data-status="Lost"] .kb-col-head .kb-title{color:var(--red)}

/* ── WORKLOAD HEATMAP ── */
.wl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.65rem;margin-top:.75rem}
.wl-card{background:var(--white);border:1px solid var(--border);border-radius:var(--rs);padding:.82rem;text-align:center}
.wl-av{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;font-family:'JetBrains Mono',monospace;margin:0 auto .45rem}
.wl-name{font-size:.77rem;font-weight:700;margin-bottom:.15rem}
.wl-cnt{font-size:.68rem;color:var(--t3);margin-bottom:.5rem}
.wl-bar-wrap{height:6px;background:var(--bg);border-radius:100px;overflow:hidden}
.wl-bar{height:100%;border-radius:100px;transition:width .6s}
.wl-status{font-size:.6rem;margin-top:.28rem;font-weight:600}

/* ── AUDIT LOG ── */
.audit-list{display:flex;flex-direction:column;gap:.38rem}
.audit-row{display:flex;align-items:flex-start;gap:.65rem;padding:.55rem .75rem;background:var(--white);border:1px solid var(--border);border-radius:var(--rs)}
.audit-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:.35rem}
.audit-body{flex:1}
.audit-text{font-size:.77rem;font-weight:500}
.audit-text b{color:var(--accent)}
.audit-meta{font-size:.62rem;color:var(--t3);margin-top:.08rem}

/* ── BULK ACTIONS BAR ── */
.bulk-bar{
  display:none;position:sticky;bottom:1.2rem;
  background:var(--text);border-radius:10px;padding:.65rem 1.1rem;
  align-items:center;gap:.85rem;box-shadow:var(--s3);
  margin:0 0 .5rem;z-index:50;
}
.bulk-bar.show{display:flex}
.bulk-count{font-size:.78rem;font-weight:700;color:#fff;flex:1}
.bulk-actions{display:flex;gap:.42rem}
.bulk-btn{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:5px;padding:.3rem .7rem;font-size:.73rem;font-weight:600;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .12s}
.bulk-btn:hover{background:rgba(255,255,255,0.2)}
.bulk-btn.danger{background:rgba(224,36,36,.2);border-color:rgba(224,36,36,.3)}
.bulk-desel{background:none;border:none;color:rgba(255,255,255,.5);font-size:.75rem;cursor:pointer}

/* ── QUICK LOG CALL PANEL ── */
.ql-panel{
  position:fixed;right:1.2rem;bottom:4rem;
  width:300px;background:var(--white);
  border:1.5px solid var(--border);border-radius:12px;
  box-shadow:var(--s3);z-index:300;
  display:none;flex-direction:column;
}
.ql-panel.open{display:flex}
.ql-head{padding:.65rem .88rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ql-title{font-size:.78rem;font-weight:700}
.ql-x{background:none;border:none;cursor:pointer;color:var(--t3);font-size:.9rem}
.ql-body{padding:.82rem}
.ql-body textarea{width:100%;border:1.5px solid var(--border);border-radius:var(--rs);padding:.55rem .7rem;font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;resize:none;height:80px;outline:none;margin-bottom:.5rem;color:var(--text)}
.ql-body textarea:focus{border-color:var(--accent)}
.ql-foot{padding:.55rem .88rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:.35rem}

/* ── DAILY FOCUS TODO ── */
.todo-section{margin-bottom:1.35rem}
.todo-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.65rem}
.todo-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.65rem}
.todo-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--rs);padding:.82rem;display:flex;gap:.6rem;align-items:flex-start;transition:all .12s}
.todo-card:hover{border-color:var(--accent);box-shadow:var(--s1)}
.todo-card.done-card{opacity:.5}
.todo-chk{width:16px;height:16px;border-radius:4px;border:1.5px solid var(--border);flex-shrink:0;cursor:pointer;margin-top:.08rem;display:flex;align-items:center;justify-content:center;transition:all .12s}
.todo-chk.checked{background:var(--green);border-color:var(--green)}
.todo-chk.checked svg{display:block}
.todo-chk svg{display:none;width:9px;height:9px;stroke:#fff;stroke-width:3;fill:none}
.todo-info{}
.todo-client{font-size:.78rem;font-weight:700}
.todo-action{font-size:.67rem;color:var(--t3);margin-top:.08rem}
.todo-due{font-size:.6rem;font-family:'JetBrains Mono',monospace;color:var(--amber);margin-top:.25rem;font-weight:600}

/* ── MENTION SYSTEM ── */
.mention-drop{
  position:absolute;background:var(--white);
  border:1.5px solid var(--border);border-radius:var(--rs);
  box-shadow:var(--s2);z-index:600;min-width:180px;
  display:none;
}
.mention-drop.open{display:block}
.mention-item{padding:.45rem .75rem;font-size:.78rem;cursor:pointer;display:flex;align-items:center;gap:.45rem}
.mention-item:hover{background:var(--ad);color:var(--accent)}
.mention-av{width:20px;height:20px;border-radius:4px;background:var(--ad);display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;color:var(--accent)}
.mention-highlight{color:var(--accent);font-weight:700}

/* ── CLIENT ACCOUNTS VIEW ── */
.acct-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:.85rem}
.acct-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:1rem;box-shadow:var(--s1);cursor:pointer;transition:all .15s}
.acct-card:hover{border-color:var(--accent);box-shadow:var(--s2)}
.acct-top{display:flex;align-items:center;gap:.65rem;margin-bottom:.75rem;padding-bottom:.65rem;border-bottom:1px solid var(--bl)}
.acct-av{width:36px;height:36px;border-radius:8px;background:var(--ad);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:800;color:var(--accent);font-family:'JetBrains Mono',monospace;flex-shrink:0}
.acct-name{font-size:.85rem;font-weight:700}
.acct-contact{font-size:.65rem;color:var(--t3);margin-top:.05rem}
.acct-nums{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.38rem;text-align:center}
.acct-num-v{font-size:.95rem;font-weight:800;font-family:'JetBrains Mono',monospace}
.acct-num-l{font-size:.56rem;color:var(--t3);text-transform:uppercase}
.acct-statuses{display:flex;gap:.25rem;flex-wrap:wrap;margin-top:.58rem}

/* ── FOLLOW-UP CALENDAR MODAL ── */
.followup-form{}
.date-inp{width:100%;border:1.5px solid var(--border);border-radius:var(--rs);padding:.58rem .75rem;font-family:'Plus Jakarta Sans',sans-serif;font-size:.84rem;outline:none;color:var(--text);background:var(--white)}
.date-inp:focus{border-color:var(--accent)}

/* ── AUDIT / ACTIVITY LOG INLINE ── */
.activity-timeline{display:flex;flex-direction:column;gap:0}
.at-row{display:flex;gap:.72rem;padding:.5rem 0;position:relative}
.at-row::before{content:'';position:absolute;left:11px;top:28px;bottom:-5px;width:1px;background:var(--border)}
.at-row:last-child::before{display:none}
.at-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--border);background:var(--white);display:flex;align-items:center;justify-content:center;flex-shrink:0;z-index:1}
.at-dot svg{width:9px;height:9px;stroke:currentColor;fill:none;stroke-width:2.5}
.at-body{flex:1;padding-top:.18rem}
.at-text{font-size:.76rem;font-weight:500}
.at-meta{font-size:.62rem;color:var(--t3)}

/* ── PIPELINE HEATMAP ── */
.heatmap-wrap{display:flex;gap:.65rem;flex-wrap:wrap;margin-top:.65rem}
.hm-stage{flex:1;min-width:140px;border-radius:var(--rs);padding:.82rem;position:relative;overflow:hidden;border:1px solid var(--border)}
.hm-stage-title{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.28rem}
.hm-count{font-size:1.6rem;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1;margin-bottom:.18rem}
.hm-days{font-size:.65rem;font-weight:600;margin-bottom:.52rem}
.hm-bar{height:5px;border-radius:100px;margin-bottom:.38rem}
.hm-stuck{font-size:.62rem;font-weight:700;padding:.18rem .42rem;border-radius:4px;display:inline-block}

/* ── SPEED OF RESPONSE TABLE ── */
.sor-table{width:100%;border-collapse:collapse}
.sor-row{display:grid;grid-template-columns:180px 1fr 90px 90px 90px 90px;align-items:center;gap:.65rem;padding:.6rem .82rem;border-bottom:1px solid var(--bl)}
.sor-row.head{background:var(--bg);font-size:.6rem;font-weight:700;letter-spacing:.7px;text-transform:uppercase;color:var(--t3);border-bottom:1px solid var(--border)}
.sor-row:last-child{border-bottom:none}
.sor-emp{display:flex;align-items:center;gap:.45rem;font-size:.78rem;font-weight:700}
.sor-bar-wrap{height:5px;background:var(--bg);border-radius:100px;overflow:hidden}
.sor-bar{height:100%;border-radius:100px;transition:width .6s}
.sor-val{font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:600;text-align:right}
.sor-grade{font-size:.62rem;font-weight:700;padding:.14rem .38rem;border-radius:4px;text-align:center}

/* ── AUTO-ASSIGNMENT RULES ── */
.rule-list{display:flex;flex-direction:column;gap:.52rem;margin-top:.65rem}
.rule-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--rs);padding:.82rem;display:flex;align-items:center;gap:.82rem;transition:all .13s}
.rule-card:hover{border-color:var(--accent)}
.rule-card.active-rule{border-color:var(--green);background:#f0fdf9}
.rule-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.rule-icon svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round}
.rule-info{flex:1}
.rule-title{font-size:.8rem;font-weight:700;margin-bottom:.12rem}
.rule-desc{font-size:.67rem;color:var(--t3)}
.rule-toggle{position:relative;width:36px;height:20px;flex-shrink:0}
.rule-toggle input{opacity:0;width:0;height:0}
.rule-slider{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:20px;transition:.2s}
.rule-slider::before{content:'';position:absolute;width:14px;height:14px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s}
.rule-toggle input:checked+.rule-slider{background:var(--green)}
.rule-toggle input:checked+.rule-slider::before{transform:translateX(16px)}

/* ── RULE BUILDER FORM ── */
.rule-builder{background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);padding:1rem;margin-top:.65rem}
.rb2{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:.52rem;align-items:end;margin-bottom:.45rem}
.rb2 .fl label{font-size:.6rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--t3)}

/* ── COMMAND CENTER TABS ── */
.cmd-tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:1.35rem}
.cmd-tab{padding:.52rem 1.1rem;font-size:.78rem;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .13s}
.cmd-tab:hover{color:var(--text)}
.cmd-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.cmd-pane{display:none}
.cmd-pane.active{display:block}

/* ── DOCUMENT ATTACH ── */
.doc-attach-list{display:flex;flex-direction:column;gap:.35rem;margin-top:.52rem}
.doc-attach-item{display:flex;align-items:center;gap:.52rem;padding:.52rem .72rem;background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);font-size:.75rem}
.doc-attach-icon{width:26px;height:26px;border-radius:5px;background:var(--ad);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.doc-attach-icon svg{width:13px;height:13px;stroke:var(--accent);fill:none;stroke-width:2}
.doc-attach-name{flex:1;font-weight:600}
.doc-attach-meta{font-size:.62rem;color:var(--t3)}
.doc-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.38rem;margin-bottom:.65rem}
.doc-type-btn{border:1.5px solid var(--border);border-radius:var(--rs);padding:.52rem .45rem;cursor:pointer;text-align:center;font-size:.68rem;font-weight:600;transition:all .12s;background:var(--white)}
.doc-type-btn:hover,.doc-type-btn.sel{border-color:var(--accent);background:var(--ad);color:var(--accent)}

/* ── GLOBAL COMMAND BAR ── */
.cmd-bar{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(15,21,35,.45);backdrop-filter:blur(6px);
  z-index:500;display:none;align-items:flex-start;justify-content:center;
  padding-top:18vh;
}
.cmd-bar.open{display:flex}
.cmd-bar-inner{width:580px;background:var(--white);border:1.5px solid var(--border);border-radius:14px;box-shadow:var(--s3);overflow:hidden}
.cmd-input-wrap{display:flex;align-items:center;gap:.65rem;padding:.82rem 1.1rem;border-bottom:1px solid var(--border)}
.cmd-input-wrap svg{width:16px;height:16px;stroke:var(--t3);fill:none;stroke-width:2;flex-shrink:0}
.cmd-input{flex:1;border:none;outline:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:.95rem;color:var(--text)}
.cmd-input::placeholder{color:var(--t3)}
.cmd-kbd{font-family:'JetBrains Mono',monospace;font-size:.6rem;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.1rem .35rem;color:var(--t3)}
.cmd-results{max-height:320px;overflow-y:auto}
.cmd-section-label{padding:.45rem 1.1rem .22rem;font-size:.58rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3)}
.cmd-result-item{padding:.6rem 1.1rem;display:flex;align-items:center;gap:.65rem;cursor:pointer;transition:background .1s}
.cmd-result-item:hover,.cmd-result-item.focused{background:var(--ad)}
.cmd-result-item.focused .cri-name{color:var(--accent)}
.cri-icon{width:28px;height:28px;border-radius:6px;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cri-icon svg{width:12px;height:12px;stroke:var(--t2);fill:none;stroke-width:2}
.cri-name{font-size:.8rem;font-weight:600;flex:1}
.cri-meta{font-size:.65rem;color:var(--t3)}
.cmd-empty{padding:2rem;text-align:center;font-size:.8rem;color:var(--t3)}
.cmd-hint{padding:.55rem 1.1rem;background:var(--bg);border-top:1px solid var(--border);display:flex;gap:1.2rem}
.cmd-hint-item{font-size:.62rem;color:var(--t3);display:flex;align-items:center;gap:.28rem}

@media(max-width:1100px){.sg{grid-template-columns:repeat(2,1fr)}.cr{grid-template-columns:1fr}.pg{grid-template-columns:1fr 1fr}.kanban-board{grid-template-columns:repeat(3,1fr)}.sor-row{grid-template-columns:120px 1fr 70px 70px}.sor-row .sor-val:nth-child(4),.sor-row .sor-val:nth-child(5){display:none}}
</style>
</head>
<body>

<div id="loading-screen">
  <div style="font-size:1.35rem;font-weight:800;letter-spacing:-.3px">W<span style="color:var(--accent)">o</span>rt</div>
  <div class="spin"></div>
  <div style="font-size:.72rem;color:var(--t3);font-family:'JetBrains Mono',monospace">Loading workspace…</div>
</div>

<div id="login-screen">
  <div class="lw">
    <div class="lh">
      <div class="ll">W<span>o</span>rt</div>
      <div class="ls">// Intelligent Logistics Management</div>
    </div>
    <div class="lc">
      <div id="lp">
        <label class="lbl">Work Email</label>
        <input class="inp" type="email" id="login-email" placeholder="you@company.com">
        <label class="lbl">Password</label>
        <input class="inp" type="password" id="login-pass" placeholder="Your password" onkeydown="if(event.key==='Enter')window.doLogin()">
        <button class="btn-enter" id="login-btn" onclick="window.doLogin()">Sign In →</button>
        <div class="as">No account? <a onclick="window.showReg()">Create one free</a></div>
      </div>
      <div id="rp" style="display:none">
        <label class="lbl">Your role</label>
        <div class="rg">
          <div class="rb" id="rb-admin" onclick="window.pickRole('admin')">
            <div class="rb-ico"><svg viewBox="0 0 24 24"><path d="M12 2l3 7h7l-5.5 4 2 7L12 17l-6.5 3 2-7L2 9h7z"/></svg></div>
            <div class="rb-name">Admin</div><div class="rb-desc">Full access, invite team</div>
          </div>
          <div class="rb" id="rb-employee" onclick="window.pickRole('employee')">
            <div class="rb-ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg></div>
            <div class="rb-name">Employee</div><div class="rb-desc">Create leads, collaborate</div>
          </div>
        </div>
        <label class="lbl">Full Name</label>
        <input class="inp" type="text" id="reg-name" placeholder="e.g. Rahul Sharma">
        <label class="lbl">Work Email</label>
        <input class="inp" type="email" id="reg-email" placeholder="you@company.com">
        <label class="lbl">Password (6+ chars)</label>
        <input class="inp" type="password" id="reg-pass" placeholder="Create a password">
        <button class="btn-enter" id="reg-btn" onclick="window.doRegister()">Create Account →</button>
        <div class="as">Have an account? <a onclick="window.showLogin()">Sign in</a></div>
      </div>
    </div>
  </div>
</div>

<div id="app-shell">
  <aside class="sidebar">
    <div class="sb-top">
      <div class="sb-logo">W<span>o</span>rt</div>
      <div class="sb-tag" id="sb-tag">Employee</div>
    </div>
    <nav class="sb-nav" id="sb-nav"></nav>
    <div class="sb-bot">
      <div class="sb-ur">
        <div class="av" id="uav">R</div>
        <div><div class="sb-un" id="uname">User</div><div class="sb-ur2" id="urole">Employee</div></div>
      </div>
      <button class="so" onclick="window.doLogout()">Sign out</button>
    </div>
  </aside>
  <div class="main">
    <div class="topbar">
      <div style="display:flex;align-items:center">
        <div class="tb-t" id="tb-title">Dashboard</div>
        <span style="color:var(--border);margin:0 .4rem">/</span>
        <div class="tb-s" id="tb-sub">Overview</div>
      </div>
      <div class="tb-r" id="tb-r">
        <button class="btn btn-outline btn-sm" onclick="window.openCmdBar()" title="Global Search (Ctrl+K)" style="font-family:'JetBrains Mono',monospace;letter-spacing:0">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          Search <span class="cmd-kbd" style="margin-left:.25rem">Ctrl K</span>
        </button>
      </div>
    </div>
    <div class="pb">

      <!-- DASHBOARD -->
      <div class="page" id="page-dashboard">
        <div class="sg" id="dash-stats"></div>
        <!-- STAGNANT LEADS WIDGET (admin only) -->
        <div class="stagnant-widget" id="stagnant-widget" style="display:none">
          <div class="sw-head">
            <div class="sw-title">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              Stagnant Leads — No activity in 48h
            </div>
            <button class="btn btn-sm btn-amber" onclick="window.showAllStagnant()">View All</button>
          </div>
          <div id="stagnant-list"></div>
        </div>
        <div class="cr">
          <div class="cc"><div class="cc-t">Leads by Source</div><div class="brl" id="src-bars"></div></div>
          <div class="cc"><div class="cc-t">Pipeline Status</div><div class="dw"><svg class="dsvg" viewBox="0 0 100 100" id="donut"></svg><div class="leg" id="donut-leg"></div></div></div>
        </div>
        <!-- WORKLOAD HEATMAP (admin) -->
        <div class="cc" id="workload-section" style="display:none;margin-bottom:1.1rem">
          <div class="cc-t">Employee Workload</div>
          <div class="wl-grid" id="wl-grid"></div>
        </div>
        <div style="font-size:.8rem;font-weight:700;margin-bottom:.65rem">Team Performance</div>
        <div class="pg" id="dash-perf"></div>
      </div>

      <!-- ALL LEADS -->
      <div class="page" id="page-leads">
        <!-- BULK ACTION BAR -->
        <div class="bulk-bar" id="bulk-bar">
          <div class="bulk-count" id="bulk-count">0 selected</div>
          <div class="bulk-actions">
            <select id="bulk-status-sel" class="fsel" style="background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.2)">
              <option value="">Change Status</option>
              <option>Submitted</option><option>Quoted</option><option>Accepted</option><option>Completed</option><option>Lost</option>
            </select>
            <button class="bulk-btn" onclick="window.bulkChangeStatus()">Apply Status</button>
            <select id="bulk-assign-sel" class="fsel" style="background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.2)">
              <option value="">Reassign to…</option>
            </select>
            <button class="bulk-btn" onclick="window.bulkReassign()">Reassign</button>
            <button class="bulk-btn danger" onclick="window.bulkDelete()">Delete</button>
          </div>
          <button class="bulk-desel" onclick="window.clearBulk()">✕ Deselect all</button>
        </div>
        <div class="tc">
          <div class="tc-h">
            <div class="tc-t">All Leads <span style="font-size:.7rem;color:var(--t3);font-weight:500" id="lc"></span></div>
            <div class="tc-a">
              <input class="srch" placeholder="Search…" oninput="window._fText=this.value;window.renderLeads()">
              <select class="fsel" onchange="window._fSt=this.value;window.renderLeads()"><option value="">All Status</option><option>Submitted</option><option>Quoted</option><option>Accepted</option><option>Completed</option><option>Lost</option></select>
              <button class="btn btn-outline btn-sm" id="sel-all-btn" onclick="window.toggleSelectAll()">Select All</button>
            </div>
          </div>
          <div class="ts"><table><thead><tr><th><input type="checkbox" id="chk-all" onchange="window.toggleSelectAll()"></th><th>Lead ID</th><th>Client</th><th>Route</th><th>Mode</th><th>Source</th><th>Status</th><th>Value</th><th>Owner</th><th>Last Activity</th><th>Actions</th></tr></thead><tbody id="leads-tb"></tbody></table></div>
        </div>
      </div>

      <!-- KANBAN -->
      <div class="page" id="page-kanban">
        <div class="kanban-board" id="kanban-board"></div>
      </div>

      <!-- MY WORK -->
      <div class="page" id="page-mywork">
        <!-- DAILY TODO FOCUS -->
        <div class="todo-section" id="todo-section">
          <div class="todo-head">
            <div style="font-size:.85rem;font-weight:700">Your Focus for Today</div>
            <span style="font-size:.7rem;color:var(--t3)" id="todo-date"></span>
          </div>
          <div class="todo-cards" id="todo-cards"></div>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.52rem">
          <div style="font-size:.8rem;font-weight:700">My Leads</div>
          <button class="btn btn-blue btn-sm" onclick="window.openCreate()">+ Create Lead</button>
        </div>
        <div class="tc" style="margin-bottom:1.2rem">
          <div class="ts"><table><thead><tr><th>Lead ID</th><th>Client</th><th>Route</th><th>Mode</th><th>Status</th><th>Value</th><th>Last Activity</th><th>Shared With</th><th>Requests</th><th>Actions</th></tr></thead><tbody id="my-tb"></tbody></table></div>
        </div>
        <div style="font-size:.8rem;font-weight:700;margin-bottom:.52rem">Leads I Collaborate On</div>
        <div class="tc">
          <div class="ts"><table><thead><tr><th>Lead ID</th><th>Client</th><th>Route</th><th>Status</th><th>Owner</th><th>My Role</th><th>Actions</th></tr></thead><tbody id="col-tb"></tbody></table></div>
        </div>
      </div>

      <!-- CLIENT ACCOUNTS -->
      <div class="page" id="page-accounts">
        <div class="tc-h" style="background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:.78rem 1.1rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between">
          <div class="tc-t">Client Accounts <span style="font-size:.7rem;color:var(--t3);font-weight:500" id="acct-count"></span></div>
          <input class="srch" placeholder="Search clients…" oninput="window.renderAccounts(this.value)">
        </div>
        <div class="acct-grid" id="acct-grid"></div>
      </div>

      <!-- AUDIT LOG -->
      <div class="page" id="page-audit">
        <div class="tc">
          <div class="tc-h">
            <div class="tc-t">Audit Log — Who Did What</div>
            <select class="fsel" onchange="window.filterAudit(this.value)"><option value="">All Actions</option><option>Created</option><option>Updated</option><option>Status Changed</option><option>Quote Added</option><option>Deleted</option><option>Reassigned</option></select>
          </div>
          <div style="padding:.75rem"><div class="audit-list" id="audit-list"></div></div>
        </div>
      </div>

      <!-- DISCOVER -->
      <div class="page" id="page-discover">
        <div class="tc">
          <div class="tc-h">
            <div class="tc-t">Discover Leads</div>
            <div class="tc-a">
              <input class="srch" placeholder="Search…" oninput="window._fdText=this.value;window.renderDiscover()">
              <select class="fsel" onchange="window._fdSt=this.value;window.renderDiscover()"><option value="">All Status</option><option>Submitted</option><option>Quoted</option><option>Accepted</option><option>Completed</option><option>Lost</option></select>
            </div>
          </div>
          <div class="ts"><table><thead><tr><th>Lead ID</th><th>Client</th><th>Route</th><th>Mode</th><th>Status</th><th>Owner</th><th>My Access</th><th>Action</th></tr></thead><tbody id="disc-tb"></tbody></table></div>
        </div>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="page" id="page-notifications">
        <div style="font-size:.8rem;font-weight:700;margin-bottom:.65rem">Notifications & Requests</div>
        <div class="notif-list" id="notif-list"></div>
      </div>

      <!-- MY ANALYTICS -->
      <div class="page" id="page-myanalytics">
        <div class="sg" id="my-stats"></div>
        <div class="cr">
          <div class="cc"><div class="cc-t">My Leads by Status</div><div class="brl" id="my-s"></div></div>
          <div class="cc"><div class="cc-t">My Leads by Mode</div><div class="brl" id="my-m"></div></div>
        </div>
      </div>

      <div class="page" id="page-reports"><div class="pg" id="rep-grid"></div></div>

      <!-- COMMAND CENTER (Admin only) -->
      <div class="page" id="page-command">
        <div class="cmd-tabs">
          <div class="cmd-tab active" onclick="window.switchCmdTab('pipeline')">Pipeline Heatmap</div>
          <div class="cmd-tab" onclick="window.switchCmdTab('speed')">Response Speed</div>
          <div class="cmd-tab" onclick="window.switchCmdTab('rules')">Auto-Assignment Rules</div>
        </div>

        <!-- PIPELINE HEATMAP PANE -->
        <div class="cmd-pane active" id="cmd-pipeline">
          <div class="cc" style="margin-bottom:1.1rem">
            <div class="cc-t">Where Are Leads Getting Stuck?</div>
            <div style="font-size:.72rem;color:var(--t3);margin-bottom:.85rem">Stages with leads older than 5 days are highlighted. Darker = more stuck.</div>
            <div class="heatmap-wrap" id="heatmap-wrap"></div>
          </div>
          <div class="cr">
            <div class="cc">
              <div class="cc-t">Stuck Leads — Needs Attention</div>
              <div id="stuck-list" style="margin-top:.52rem"></div>
            </div>
            <div class="cc">
              <div class="cc-t">Value at Risk by Stage</div>
              <div class="brl" id="risk-bars" style="margin-top:.52rem"></div>
            </div>
          </div>
        </div>

        <!-- SPEED OF RESPONSE PANE -->
        <div class="cmd-pane" id="cmd-speed">
          <div class="cc" style="margin-bottom:1.1rem">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.82rem">
              <div class="cc-t" style="margin:0">Employee Response Speed</div>
              <div style="font-size:.68rem;color:var(--t3)">Time from lead creation → first quote submitted</div>
            </div>
            <div class="sor-row head">
              <div>Employee</div>
              <div>Avg Response Time</div>
              <div class="sor-val">Leads</div>
              <div class="sor-val">Fastest</div>
              <div class="sor-val">Slowest</div>
              <div class="sor-val">Grade</div>
            </div>
            <div id="sor-rows"></div>
          </div>
          <div class="cc">
            <div class="cc-t">Team Benchmark</div>
            <div id="benchmark-content" style="margin-top:.65rem"></div>
          </div>
        </div>

        <!-- AUTO-ASSIGNMENT RULES PANE -->
        <div class="cmd-pane" id="cmd-rules">
          <div class="cc" style="margin-bottom:1.1rem">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.82rem">
              <div class="cc-t" style="margin:0">Assignment Rules Engine</div>
              <button class="btn btn-blue btn-sm" onclick="window.openRuleBuilder()">+ New Rule</button>
            </div>
            <div style="font-size:.72rem;color:var(--t3);margin-bottom:.82rem">Rules are evaluated in order when a new lead is created. First matching rule wins.</div>

            <!-- RULE BUILDER (hidden by default) -->
            <div class="rule-builder" id="rule-builder" style="display:none">
              <div style="font-size:.78rem;font-weight:700;margin-bottom:.75rem">Build a New Rule</div>
              <div class="rb2">
                <div class="fl">
                  <label class="lbl">IF field</label>
                  <select class="inp" id="rule-field" style="margin:0" onchange="window.updateRulePreview()">
                    <option value="origin">Origin City</option>
                    <option value="dest">Destination Country</option>
                    <option value="mode">Freight Mode</option>
                    <option value="source">Lead Source</option>
                    <option value="value">Lead Value (₹)</option>
                  </select>
                </div>
                <div class="fl">
                  <label class="lbl">Operator</label>
                  <select class="inp" id="rule-op" style="margin:0" onchange="window.updateRulePreview()">
                    <option>contains</option>
                    <option>equals</option>
                    <option>starts with</option>
                    <option>greater than</option>
                  </select>
                </div>
                <div class="fl">
                  <label class="lbl">Value</label>
                  <input class="inp" id="rule-val" placeholder="e.g. USA, Sea, 500000" style="margin:0" oninput="window.updateRulePreview()">
                </div>
                <div></div>
              </div>
              <div class="rb2">
                <div class="fl">
                  <label class="lbl">THEN assign to</label>
                  <select class="inp" id="rule-assignee" style="margin:0" onchange="window.updateRulePreview()">
                    <option value="__loadbalance__">Auto — Load Balance</option>
                  </select>
                </div>
                <div class="fl">
                  <label class="lbl">Rule Priority</label>
                  <select class="inp" id="rule-priority" style="margin:0">
                    <option value="1">1 — Highest</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="5" selected>5 — Default</option>
                    <option value="9">9 — Lowest</option>
                  </select>
                </div>
                <div class="fl" style="grid-column:span 2">
                  <label class="lbl">Preview</label>
                  <div id="rule-preview" style="font-size:.78rem;color:var(--accent);font-weight:600;padding:.45rem .72rem;background:var(--ad);border-radius:var(--rs);border:1px solid var(--ab)">—</div>
                </div>
              </div>
              <div style="display:flex;justify-content:flex-end;gap:.38rem;margin-top:.52rem">
                <button class="btn btn-ghost btn-sm" onclick="window.closeRuleBuilder()">Cancel</button>
                <button class="btn btn-blue btn-sm" onclick="window.saveRule()">Save Rule</button>
              </div>
            </div>

            <div class="rule-list" id="rule-list"></div>
          </div>

          <div class="cc">
            <div class="cc-t">Load Balancing — Current Distribution</div>
            <div style="font-size:.72rem;color:var(--t3);margin-bottom:.65rem">When "Auto — Load Balance" is selected, new leads go to the employee with fewest active leads.</div>
            <div id="loadbalance-viz"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->

<!-- CREATE/EDIT LEAD MODAL -->
<div class="ov" id="m-lead">
  <div class="modal">
    <div class="mh"><div class="mh-t" id="ml-t">Create Lead</div><button class="mh-x" onclick="window.closeM('m-lead')">✕</button></div>
    <div class="mb">
      <!-- DUPLICATE WARNING -->
      <div class="dup-warn" id="dup-warn">
        <span id="dup-msg">⚠ This client already exists.</span>
        <button onclick="window.viewDuplicateClient()">View History</button>
      </div>
      <div class="fg">
        <!-- CLIENT with auto-suggest -->
        <div class="fl suggest-wrap">
          <label class="lbl">Client Name *</label>
          <input class="inp" id="f-client" placeholder="Type to search existing clients…" style="margin:0" autocomplete="off"
            oninput="window.onClientInput(this.value)" onfocus="window.onClientInput(this.value)" onblur="setTimeout(()=>window.closeSuggest(),200)">
          <div class="suggest-drop" id="client-suggest"></div>
        </div>
        <div class="fl">
          <label class="lbl">Contact (Phone / Email)</label>
          <input class="inp" id="f-contact" placeholder="+91 00000 00000" style="margin:0" oninput="window.checkDuplicate(this.value)">
        </div>
        <div class="fl"><label class="lbl">Origin *</label><input class="inp" id="f-origin" placeholder="e.g. Mumbai" style="margin:0"></div>
        <div class="fl"><label class="lbl">Destination *</label><input class="inp" id="f-dest" placeholder="e.g. Dubai, UAE" style="margin:0"></div>
        <div class="fl"><label class="lbl">Cargo / Product *</label><input class="inp" id="f-cargo" placeholder="e.g. Heavy Machinery" style="margin:0"></div>
        <div class="fl"><label class="lbl">Container</label><select class="inp" id="f-cont" style="margin:0"><option value="">Select</option><option>20ft FCL</option><option>40ft FCL</option><option>LCL</option><option>Bulk</option><option>Break Bulk</option><option>N/A</option></select></div>
        <div class="fl"><label class="lbl">Mode *</label><select class="inp" id="f-mode" style="margin:0"><option value="">Select</option><option>Air</option><option>Sea</option><option>Road</option><option>Multimodal</option></select></div>
        <div class="fl"><label class="lbl">Lead Source *</label><select class="inp" id="f-src" style="margin:0"><option value="">Select</option><option>Mouth to Mouth</option><option>Sales Visit</option><option>Repeat Client</option><option>Newspaper / Magazine</option><option>Cold Call</option><option>Reference</option><option>Online Enquiry</option><option>Trade Fair</option><option>Other</option></select></div>
        <div class="fl"><label class="lbl">Status</label><select class="inp" id="f-status" style="margin:0"><option>Submitted</option><option>Quoted</option><option>Accepted</option><option>Completed</option><option>Lost</option></select></div>
        <div class="fl"><label class="lbl">Est. Value (INR)</label><input class="inp" type="number" id="f-value" placeholder="e.g. 250000" style="margin:0"></div>
        <div class="fl full" style="position:relative">
          <label class="lbl">Notes (type @ to mention)</label>
          <textarea class="inp" id="f-notes" placeholder="Additional notes… type @name to mention team members" style="margin:0" oninput="window.onNotesInput(event)"></textarea>
          <div class="mention-drop" id="mention-drop"></div>
        </div>
      </div>
      <div id="inv-wrap" style="display:none">
        <div class="sec-lbl">Invite Team Members</div>
        <div style="font-size:.69rem;color:var(--t3);margin-bottom:.48rem">Invited members get immediate edit access.</div>
        <div class="inv-grid" id="inv-grid"></div>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-ghost" onclick="window.closeM('m-lead')">Cancel</button>
      <button class="btn btn-blue" id="ml-sb" onclick="window.saveLead()">Create Lead</button>
    </div>
  </div>
</div>

<!-- LEAD DETAIL MODAL -->
<div class="ov" id="m-detail">
  <div class="modal mlg">
    <div class="mh"><div class="mh-t" id="md-t">Lead Details</div><button class="mh-x" onclick="window.closeM('m-detail')">✕</button></div>
    <div class="mb" id="md-b"></div>
  </div>
</div>

<!-- QUOTE MODAL -->
<div class="ov" id="m-quote">
  <div class="modal" style="max-width:420px">
    <div class="mh"><div class="mh-t">Submit Quote</div><button class="mh-x" onclick="window.closeM('m-quote')">✕</button></div>
    <div class="mb">
      <div class="fg">
        <div class="fl"><label class="lbl">Quote Value *</label><input class="inp" type="number" id="q-val" placeholder="e.g. 185000" style="margin:0"></div>
        <div class="fl"><label class="lbl">Currency</label><select class="inp" id="q-cur" style="margin:0"><option>INR</option><option>USD</option><option>EUR</option><option>AED</option></select></div>
        <div class="fl full"><label class="lbl">ETA / Delivery</label><input class="inp" id="q-eta" placeholder="e.g. 12–15 working days" style="margin:0"></div>
        <div class="fl full"><label class="lbl">Remarks</label><textarea class="inp" id="q-notes" placeholder="Terms, breakdown…" style="margin:0"></textarea></div>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-ghost" onclick="window.closeM('m-quote')">Cancel</button>
      <button class="btn btn-blue" onclick="window.saveQuote()">Submit Quote</button>
    </div>
  </div>
</div>

<!-- REQUEST ACCESS MODAL -->
<div class="ov" id="m-req">
  <div class="modal" style="max-width:420px">
    <div class="mh"><div class="mh-t">Request Edit Access</div><button class="mh-x" onclick="window.closeM('m-req')">✕</button></div>
    <div class="mb">
      <div class="ban ban-blue" style="margin-bottom:.88rem">Your request goes to the lead owner. Once approved you can fully edit, quote, and update this lead.</div>
      <div class="fl"><label class="lbl">Reason *</label><textarea class="inp" id="req-r" placeholder="Why do you need edit access?" style="margin:0"></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-ghost" onclick="window.closeM('m-req')">Cancel</button>
      <button class="btn btn-blue" onclick="window.submitReq()">Send Request</button>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="ov" id="m-share">
  <div class="modal" style="max-width:490px">
    <div class="mh"><div class="mh-t">Share & Manage Access</div><button class="mh-x" onclick="window.closeM('m-share')">✕</button></div>
    <div class="mb" id="ms-b"></div>
    <div class="mf"><button class="btn btn-ghost" onclick="window.closeM('m-share')">Close</button></div>
  </div>
</div>

<!-- FOLLOW-UP MODAL -->
<div class="ov" id="m-followup">
  <div class="modal" style="max-width:400px">
    <div class="mh"><div class="mh-t">Schedule Follow-up</div><button class="mh-x" onclick="window.closeM('m-followup')">✕</button></div>
    <div class="mb">
      <div class="fl" style="margin-bottom:.65rem">
        <label class="lbl">Client / Lead</label>
        <div style="font-size:.85rem;font-weight:700" id="fu-client">—</div>
      </div>
      <div class="fl" style="margin-bottom:.65rem">
        <label class="lbl">Follow-up Date & Time</label>
        <input type="datetime-local" class="date-inp" id="fu-date">
      </div>
      <div class="fl" style="margin-bottom:.65rem">
        <label class="lbl">Reminder Note</label>
        <textarea class="inp" id="fu-note" placeholder="What to discuss…" style="margin:0;height:70px;resize:none"></textarea>
      </div>
      <div style="font-size:.7rem;color:var(--t3)">Opens a Google Calendar event in a new tab.</div>
    </div>
    <div class="mf">
      <button class="btn btn-ghost" onclick="window.closeM('m-followup')">Cancel</button>
      <button class="btn btn-blue" onclick="window.saveFollowUp()">Open in Google Calendar</button>
    </div>
  </div>
</div>

<!-- REASSIGN MODAL (stagnant leads) -->
<div class="ov" id="m-reassign">
  <div class="modal" style="max-width:400px">
    <div class="mh"><div class="mh-t">Auto-Reassign Lead</div><button class="mh-x" onclick="window.closeM('m-reassign')">✕</button></div>
    <div class="mb">
      <div class="ban ban-amber" style="margin-bottom:.82rem">This lead has had no activity for 48+ hours. Reassign it to a fresh executive.</div>
      <div class="fl">
        <label class="lbl">Assign To</label>
        <select class="inp" id="reassign-to" style="margin:0"></select>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-ghost" onclick="window.closeM('m-reassign')">Cancel</button>
      <button class="btn btn-blue" onclick="window.doReassign()">Reassign Now</button>
    </div>
  </div>
</div>

<!-- QUICK LOG CALL PANEL -->
<div class="ql-panel" id="ql-panel">
  <div class="ql-head">
    <div class="ql-title">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5" stroke-linecap="round" style="display:inline-block;vertical-align:middle;margin-right:.3rem"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 11.5a19.79 19.79 0 01-3.07-8.67A2 2 0 012 .84h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.91 8.09a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0121.16 15l-.01.02-.01.02-.01-.02.01.02c0-.01-.01-.01 0 0l.01-.02v.92z"/></svg>
      Log Call — <span id="ql-client" style="color:var(--t3);font-weight:500"></span>
    </div>
    <button class="ql-x" onclick="window.closeCallLog()">✕</button>
  </div>
  <div class="ql-body">
    <div style="font-size:.65rem;color:var(--t3);margin-bottom:.42rem">Outcome</div>
    <div style="display:flex;gap:.35rem;margin-bottom:.55rem">
      <button class="btn btn-sm btn-green" id="co-reached" onclick="window.setCallOutcome('Reached')">Reached</button>
      <button class="btn btn-sm btn-outline" id="co-vm" onclick="window.setCallOutcome('Voicemail')">Voicemail</button>
      <button class="btn btn-sm btn-outline" id="co-na" onclick="window.setCallOutcome('No Answer')">No Answer</button>
    </div>
    <textarea id="ql-notes" placeholder="Call notes… what was discussed?"></textarea>
  </div>
  <div class="ql-foot">
    <button class="btn btn-ghost btn-sm" onclick="window.closeCallLog()">Cancel</button>
    <button class="btn btn-blue btn-sm" onclick="window.saveCallLog()">Save Note</button>
  </div>
</div>

<!-- GLOBAL COMMAND BAR -->
<div class="cmd-bar" id="cmd-bar" onclick="if(event.target===this)window.closeCmdBar()">
  <div class="cmd-bar-inner">
    <div class="cmd-input-wrap">
      <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="cmd-input" id="cmd-input" placeholder="Search leads, clients, navigate…" oninput="window.cmdSearch(this.value)" onkeydown="window.cmdKeyNav(event)" autocomplete="off">
      <span class="cmd-kbd">ESC</span>
    </div>
    <div class="cmd-results" id="cmd-results">
      <div class="cmd-section-label">Quick Actions</div>
      <div class="cmd-result-item" onclick="window.closeCmdBar();window.openCreate()">
        <div class="cri-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
        <div class="cri-name">Create New Lead</div>
        <div class="cri-meta">Open lead form</div>
      </div>
      <div class="cmd-result-item" onclick="window.closeCmdBar();window.goTo('kanban')">
        <div class="cri-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="12" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg></div>
        <div class="cri-name">Open Kanban Board</div>
        <div class="cri-meta">Pipeline view</div>
      </div>
      <div class="cmd-result-item" onclick="window.closeCmdBar();window.goTo('command')">
        <div class="cri-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
        <div class="cri-name">Command Center</div>
        <div class="cri-meta">Analytics & rules</div>
      </div>
    </div>
    <div class="cmd-hint">
      <div class="cmd-hint-item"><span class="cmd-kbd">↑↓</span> Navigate</div>
      <div class="cmd-hint-item"><span class="cmd-kbd">Enter</span> Select</div>
      <div class="cmd-hint-item"><span class="cmd-kbd">ESC</span> Close</div>
    </div>
  </div>
</div>

<!-- DOCUMENT ATTACH MODAL -->
<div class="ov" id="m-docs">
  <div class="modal" style="max-width:500px">
    <div class="mh"><div class="mh-t">Attach Export Documents — <span id="doc-lead-name" style="color:var(--accent);font-weight:600"></span></div><button class="mh-x" onclick="window.closeM('m-docs')">✕</button></div>
    <div class="mb">
      <div style="font-size:.72rem;color:var(--t3);margin-bottom:.82rem">Link export documents directly to this lead. No more hunting through folders.</div>
      <div style="font-size:.68rem;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.48rem">Document Type</div>
      <div class="doc-type-grid" id="doc-type-grid">
        <div class="doc-type-btn" onclick="window.selectDocType(this,'ICEGATE Draft')">ICEGATE Draft</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'Shipping Bill')">Shipping Bill</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'Bill of Lading')">Bill of Lading</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'Commercial Invoice')">Commercial Invoice</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'Packing List')">Packing List</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'Certificate of Origin')">Certificate of Origin</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'LC / Bank Draft')">LC / Bank Draft</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'Insurance Certificate')">Insurance Cert.</div>
        <div class="doc-type-btn" onclick="window.selectDocType(this,'Other')">Other</div>
      </div>
      <div class="fl" style="margin-bottom:.65rem">
        <label class="lbl">Document Name / Reference</label>
        <input class="inp" id="doc-name" placeholder="e.g. SB/2025/JNPT/00412" style="margin:0">
      </div>
      <div class="fl" style="margin-bottom:.65rem">
        <label class="lbl">Link / File Reference</label>
        <input class="inp" id="doc-link" placeholder="Google Drive link or internal ref." style="margin:0">
      </div>
      <div class="fl">
        <label class="lbl">Notes</label>
        <input class="inp" id="doc-notes-inp" placeholder="Any context…" style="margin:0">
      </div>
      <div class="sec-lbl">Attached Documents</div>
      <div class="doc-attach-list" id="doc-attach-list"><div style="font-size:.73rem;color:var(--t3)">No documents attached yet.</div></div>
    </div>
    <div class="mf">
      <button class="btn btn-ghost" onclick="window.closeM('m-docs')">Close</button>
      <button class="btn btn-blue" onclick="window.saveDoc()">Attach Document</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="tdot"></div><div class="tm" id="tm">Done</div></div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged,updateProfile}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import{getFirestore,collection,doc,addDoc,setDoc,getDoc,getDocs,updateDoc,deleteDoc,onSnapshot,query,orderBy,serverTimestamp,arrayUnion,arrayRemove,where}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig={apiKey:"AIzaSyDtrhy6HsZLIPPS0_cX0fVYVI4l6HnxnXg",authDomain:"wort-b848f.firebaseapp.com",projectId:"wort-b848f",storageBucket:"wort-b848f.firebasestorage.app",messagingSenderId:"371737860780",appId:"1:371737860780:web:ae8f0a088535b6d088dd09"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUser=null,userProfile=null,leads=[],allUsers=[],auditLogs=[],unsubLeads=null;
let editingLeadId=null,quotingLeadId=null,reqLeadId=null,shareLeadId=null,invSet=new Set();
let callLogLeadId=null,callOutcome='Reached',followUpLeadId=null,reassignLeadId=null;
let selectedLeads=new Set(),dupClientId=null;
window._fText='';window._fSt='';window._fdText='';window._fdSt='';

const ge=id=>document.getElementById(id);
const val=id=>(ge(id)?.value||'').trim();
const today=()=>new Date().toISOString().split('T')[0];
const now=()=>new Date().toISOString();
const money=n=>n?'₹'+Number(n).toLocaleString('en-IN'):'—';
const bdg=(t,c)=>`<span class="bdg ${c}">${t}</span>`;
const emptyRow=m=>`<div class="empty">${m||'No records.'}</div>`;
const SC={Submitted:'bs',Quoted:'bq',Accepted:'ba',Completed:'bc',Lost:'bl'};
const MC={Air:'bair',Sea:'bsea',Road:'broad',Multimodal:'bmulti'};
const SCC={Submitted:'#2563eb',Quoted:'#d97706',Accepted:'#7c3aed',Completed:'#059669',Lost:'#dc2626'};
const WLC=['#1a56db','#0d9f6e','#c27803','#7e3af2','#0694a2','#e02424'];
window.ge=ge;

function timeAgo(iso){
  if(!iso)return'—';
  const diff=Date.now()-new Date(iso).getTime();
  const h=Math.floor(diff/3600000),m=Math.floor(diff/60000);
  if(h>48)return Math.floor(h/24)+'d ago';
  if(h>0)return h+'h ago';
  if(m>0)return m+'m ago';
  return'just now';
}
function isStagnant(l){
  const ts=l.lastActivity||l.createdAt?.toDate?.()?.toISOString()||null;
  if(!ts)return true;
  return(Date.now()-new Date(ts).getTime())>48*3600000;
}

function friendlyErr(e){
  return({'auth/user-not-found':'No account with that email','auth/wrong-password':'Incorrect password','auth/email-already-in-use':'Email already registered','auth/weak-password':'Password too weak','auth/invalid-email':'Invalid email','auth/invalid-credential':'Incorrect email or password'})[e.code]||e.message;
}

function showScreen(s){
  ge('loading-screen').style.display=s==='loading'?'flex':'none';
  ge('login-screen').style.display=s==='login'?'flex':'none';
  ge('app-shell').style.display=s==='app'?'flex':'none';
}

onAuthStateChanged(auth,async user=>{
  if(user){
    currentUser=user;
    try{
      const snap=await getDoc(doc(db,'users',user.uid));
      if(snap.exists()){userProfile=snap.data();enterApp();}
      else{const rp=ge('rp');if(!rp||rp.style.display!=='block'){await signOut(auth);showScreen('login');}}
    }catch(err){console.error('Firestore error:',err);showScreen('login');}
  }else{
    currentUser=null;userProfile=null;
    if(unsubLeads){unsubLeads();unsubLeads=null;}
    showScreen('login');
  }
});

function enterApp(){
  const{name,role}=userProfile;
  ge('uav').textContent=name[0].toUpperCase();
  ge('uname').textContent=name;
  ge('urole').textContent=role==='admin'?'Administrator':'Employee';
  ge('sb-tag').textContent=role==='admin'?'Admin':'Employee';
  buildNav();
  subscribeLeads();
  loadAuditLogs();
  goTo(role==='admin'?'dashboard':'mywork');
  showScreen('app');
  // Set today label
  const d=new Date();
  const el=ge('todo-date');
  if(el)el.textContent=d.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long'});
}

window.doLogin=async function(){
  const email=val('login-email'),pass=val('login-pass');
  if(!email||!pass)return toast('Enter email and password','err');
  const btn=ge('login-btn');btn.disabled=true;btn.textContent='Signing in…';
  try{await signInWithEmailAndPassword(auth,email,pass);}
  catch(e){toast(friendlyErr(e),'err');btn.disabled=false;btn.textContent='Sign In →';}
};

window.doRegister=async function(){
  const name=val('reg-name'),email=val('reg-email'),pass=val('reg-pass'),role=window._regRole;
  if(!name||!email||!pass)return toast('Fill all fields','err');
  if(!role)return toast('Select a role first','err');
  if(pass.length<6)return toast('Password needs 6+ characters','err');
  const btn=ge('reg-btn');btn.disabled=true;btn.textContent='Creating…';
  try{
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    await setDoc(doc(db,'users',cred.user.uid),{name,email,role,createdAt:serverTimestamp()});
    userProfile={name,email,role};
    toast('Welcome, '+name+'!');
    enterApp();
  }catch(e){toast(friendlyErr(e),'err');btn.disabled=false;btn.textContent='Create Account →';}
};

window.doLogout=async function(){
  if(unsubLeads){unsubLeads();unsubLeads=null;}
  await signOut(auth);
};

window._regRole=null;
window.pickRole=function(r){
  window._regRole=r;
  document.querySelectorAll('.rb').forEach(b=>b.classList.remove('sel'));
  ge('rb-'+r).classList.add('sel');
};
window.showReg=()=>{ge('lp').style.display='none';ge('rp').style.display='block';};
window.showLogin=()=>{ge('lp').style.display='block';ge('rp').style.display='none';};

function subscribeLeads(){
  if(unsubLeads)unsubLeads();
  unsubLeads=onSnapshot(query(collection(db,'leads'),orderBy('createdAt','desc')),snap=>{
    leads=snap.docs.map(d=>({id:d.id,...d.data()}));
    leads.forEach(l=>{l.quotes=l.quotes||[];l.invitees=l.invitees||[];l.accessRequests=l.accessRequests||[];l.callLogs=l.callLogs||[];});
    refreshCurrentPage();refreshDots();
  },err=>console.error('Snapshot:',err));
}

async function loadUsers(){
  const snap=await getDocs(collection(db,'users'));
  allUsers=snap.docs.map(d=>({uid:d.id,...d.data()}));
}

async function loadAuditLogs(){
  try{
    const snap=await getDocs(query(collection(db,'audit'),orderBy('ts','desc')));
    auditLogs=snap.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){auditLogs=[];}
}

async function writeAudit(action,leadId,client,details){
  try{
    const entry={action,leadId,client,details,by:userProfile.name,ts:now()};
    await addDoc(collection(db,'audit'),entry);
    auditLogs.unshift(entry);
    if(document.querySelector('#page-audit.active'))renderAudit();
  }catch(e){}
}

function canEdit(l){
  if(!userProfile||!currentUser)return false;
  if(userProfile.role==='admin')return true;
  if(l.ownerUid===currentUser.uid)return true;
  if((l.invitees||[]).includes(userProfile.name))return true;
  if((l.accessRequests||[]).some(r=>r.by===userProfile.name&&r.status==='approved'))return true;
  return false;
}
function collabsOf(l){
  const out=[];
  (l.invitees||[]).forEach(n=>out.push({name:n,type:'invited'}));
  (l.accessRequests||[]).filter(r=>r.status==='approved'&&!(l.invitees||[]).includes(r.by)).forEach(r=>out.push({name:r.by,type:'approved'}));
  return out;
}
function myAccess(l){
  if(l.ownerUid===currentUser?.uid)return '<span class="chip">Owner</span>';
  if((l.invitees||[]).includes(userProfile.name))return '<span class="chip">Invited</span>';
  const r=(l.accessRequests||[]).find(r=>r.by===userProfile.name);
  if(r?.status==='approved')return '<span class="chip">Approved</span>';
  if(r?.status==='pending')return '<span class="chip chip-wait">Pending</span>';
  return '<span class="chip chip-view">View only</span>';
}
function pendingCount(){
  if(!userProfile)return 0;
  return leads.reduce((s,l)=>{if(l.ownerUid===currentUser?.uid||userProfile.role==='admin')s+=(l.accessRequests||[]).filter(r=>r.status==='pending').length;return s;},0);
}

const NAVS={
  admin:[
    {id:'dashboard',l:'Dashboard',icon:'grid'},
    {id:'leads',l:'All Leads',icon:'list'},
    {id:'kanban',l:'Pipeline Kanban',icon:'kanban'},
    {id:'accounts',l:'Client Accounts',icon:'users2'},
    {id:'command',l:'Command Center',icon:'command'},
    {id:'audit',l:'Audit Log',icon:'audit'},
    {id:'notifications',l:'Requests',icon:'bell',dot:true},
    {id:'reports',l:'Reports',icon:'users'}
  ],
  employee:[
    {id:'mywork',l:'My Workspace',icon:'list'},
    {id:'accounts',l:'Client Accounts',icon:'users2'},
    {id:'discover',l:'Discover Leads',icon:'search'},
    {id:'notifications',l:'Notifications',icon:'bell',dot:true},
    {id:'myanalytics',l:'My Analytics',icon:'chart'}
  ]
};
const ICONS={
  grid:'<rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>',
  list:'<path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/>',
  bell:'<path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>',
  users:'<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>',
  users2:'<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>',
  search:'<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
  chart:'<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
  kanban:'<rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="12" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/>',
  audit:'<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>',
  command:'<path d="M18 3a3 3 0 00-3 3v12a3 3 0 003 3 3 3 0 003-3 3 3 0 00-3-3H6a3 3 0 00-3 3 3 3 0 003 3 3 3 0 003-3V6a3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3h12a3 3 0 003-3 3 3 0 00-3-3z"/>'
};
const METAS={
  dashboard:['Dashboard','Company overview'],
  leads:['All Leads','Full lead registry'],
  kanban:['Pipeline Kanban','Drag & drop view'],
  accounts:['Client Accounts','Grouped by client'],
  command:['Command Center','Heatmap · Response speed · Auto-assignment'],
  audit:['Audit Log','Who did what'],
  notifications:['Requests','Access & invitation notifications'],
  reports:['Reports','Team performance'],
  mywork:['My Workspace','Your leads and collaborations'],
  discover:['Discover Leads','Browse & request access'],
  myanalytics:['My Analytics','Your personal stats']
};

function buildNav(){
  ge('sb-nav').innerHTML='<div class="sb-sec">Navigation</div>'+
    NAVS[userProfile.role].map(n=>`<div class="sb-item" id="n-${n.id}" onclick="window.goTo('${n.id}')"><div class="sb-ico"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${ICONS[n.icon]}</svg></div>${n.l}${n.dot?`<div class="n-dot" id="nd-${n.id}" style="display:none"></div>`:''}</div>`).join('');
}

window.goTo=function(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(n=>n.classList.remove('active'));
  ge('page-'+id)?.classList.add('active');
  ge('n-'+id)?.classList.add('active');
  const[t,s]=METAS[id]||['',''];
  ge('tb-title').textContent=t;ge('tb-sub').textContent=s;
  // Reset tb-r but keep search button
  ge('tb-r').innerHTML=`<button class="btn btn-outline btn-sm" onclick="window.openCmdBar()" title="Global Search (Ctrl+K)" style="font-family:'JetBrains Mono',monospace;letter-spacing:0"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> <span class="cmd-kbd" style="margin-left:.25rem">Ctrl K</span></button>`;
  if(id==='leads')ge('tb-r').innerHTML+=`<button class="btn btn-blue btn-sm" onclick="window.openCreate()">+ Create Lead</button>`;
  if(id==='kanban')ge('tb-r').innerHTML+=`<button class="btn btn-blue btn-sm" onclick="window.openCreate()">+ Create Lead</button>`;
  ({dashboard:renderDash,leads:renderLeads,kanban:renderKanban,accounts:renderAccounts,command:renderCommand,audit:renderAudit,notifications:renderNotifs,reports:renderReports,mywork:renderMyWork,discover:renderDiscover,myanalytics:renderMyAna}[id]||Function)();
};

function refreshCurrentPage(){
  const p=document.querySelector('.page.active');if(!p)return;
  ({dashboard:renderDash,leads:renderLeads,kanban:renderKanban,accounts:renderAccounts,command:renderCommand,audit:renderAudit,notifications:renderNotifs,reports:renderReports,mywork:renderMyWork,discover:renderDiscover,myanalytics:renderMyAna}[p.id.replace('page-','')]||Function)();
}
function refreshDots(){const el=ge('nd-notifications');if(el)el.style.display=pendingCount()>0?'block':'none';}

/* ════════════════════════════════════════════
   DASHBOARD
════════════════════════════════════════════ */
function renderDash(){
  const tot=leads.length,done=leads.filter(l=>l.status==='Completed').length;
  const pipe=leads.reduce((s,l)=>s+(l.value||0),0),rate=tot?Math.round(done/tot*100):0;
  const stagnant=leads.filter(l=>isStagnant(l)&&l.status!=='Completed'&&l.status!=='Lost');
  ge('dash-stats').innerHTML=[
    {v:tot,l:'Total Leads',bg:'var(--ad)',c:'var(--accent)',ico:'<path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/>'},
    {v:done,l:'Completed',bg:'var(--gd)',c:'var(--green)',ico:'<polyline points="20 6 9 17 4 12"/>'},
    {v:rate+'%',l:'Conv. Rate',bg:'var(--amd)',c:'var(--amber)',ico:'<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>'},
    {v:'₹'+(pipe/100000).toFixed(1)+'L',l:'Pipeline',bg:'var(--vd)',c:'var(--violet)',ico:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>'},
    {v:stagnant.length,l:'Stagnant (48h)',bg:'var(--rd)',c:'var(--red)',ico:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'}
  ].map(s=>`<div class="sc"><div class="sc-top"><div class="sc-ico" style="background:${s.bg};color:${s.c}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">${s.ico}</svg></div></div><div class="sc-v">${s.v}</div><div class="sc-l">${s.l}</div></div>`).join('');

  // Stagnant widget
  if(userProfile.role==='admin'){
    const sw=ge('stagnant-widget');
    if(stagnant.length>0){
      sw.style.display='block';
      ge('stagnant-list').innerHTML=stagnant.slice(0,3).map(l=>`
        <div class="stag-row">
          <div class="stag-info">
            <div class="stag-name">${l.client}</div>
            <div class="stag-meta">${l.owner} · ${l.origin} → ${l.dest} · Last: ${timeAgo(l.lastActivity)}</div>
          </div>
          <div class="stag-actions">
            <button class="btn btn-sm btn-outline" onclick="window.openReassign('${l.id}')">Reassign</button>
            <button class="btn btn-sm btn-ghost" onclick="window.viewLead('${l.id}')">View</button>
          </div>
        </div>`).join('');
    }else{sw.style.display='none';}

    // Workload heatmap
    const ws=ge('workload-section');
    ws.style.display='block';
    const emp={};leads.forEach(l=>emp[l.owner]=(emp[l.owner]||0)+1);
    const maxW=Math.max(...Object.values(emp),1);
    ge('wl-grid').innerHTML=Object.entries(emp).sort((a,b)=>b[1]-a[1]).map(([name,cnt],i)=>{
      const pct=cnt/maxW*100;
      const color=pct>80?'var(--red)':pct>50?'var(--amber)':'var(--green)';
      const label=pct>80?'High Load':pct>50?'Moderate':'Healthy';
      return `<div class="wl-card">
        <div class="wl-av" style="background:${WLC[i%6]}22;color:${WLC[i%6]}">${name[0]}</div>
        <div class="wl-name">${name}</div>
        <div class="wl-cnt">${cnt} active lead${cnt!==1?'s':''}</div>
        <div class="wl-bar-wrap"><div class="wl-bar" style="width:${pct}%;background:${color}"></div></div>
        <div class="wl-status" style="color:${color}">${label}</div>
      </div>`;
    }).join('');
  }

  const src={};leads.forEach(l=>src[l.source]=(src[l.source]||0)+1);
  const maxS=Math.max(...Object.values(src),1);
  const clrs=['#1a56db','#0d9f6e','#c27803','#7e3af2','#0694a2','#e02424','#d97706','#059669'];
  ge('src-bars').innerHTML=Object.entries(src).sort((a,b)=>b[1]-a[1]).map(([k,v],i)=>`<div class="br"><div class="br-l">${k}</div><div class="brt"><div class="brf" style="width:${v/maxS*100}%;background:${clrs[i%8]}"></div></div><div class="br-n">${v}</div></div>`).join('');

  const st={Submitted:0,Quoted:0,Accepted:0,Completed:0,Lost:0};
  leads.forEach(l=>st[l.status]=(st[l.status]||0)+1);
  const t2=Object.values(st).reduce((a,b)=>a+b,0)||1;let off=0,paths='';
  Object.entries(st).forEach(([k,v])=>{const pct=v/t2,r=42,c=2*Math.PI*r;if(v>0)paths+=`<circle cx="50" cy="50" r="${r}" fill="none" stroke="${SCC[k]}" stroke-width="14" stroke-dasharray="${pct*c} ${c}" stroke-dashoffset="${-off*c}" transform="rotate(-90 50 50)"/>`;off+=pct;});
  ge('donut').innerHTML=paths+`<text x="50" y="55" text-anchor="middle" fill="var(--text)" font-size="13" font-family="JetBrains Mono,monospace" font-weight="700">${t2}</text>`;
  ge('donut-leg').innerHTML=Object.entries(st).map(([k,v])=>`<div class="leg-r"><div class="leg-d" style="background:${SCC[k]}"></div><div class="leg-l">${k}</div><div class="leg-v">${v}</div></div>`).join('');
  ge('dash-perf').innerHTML=[...new Set(leads.map(l=>l.owner))].slice(0,6).map(perfCard).join('');
}

function perfCard(emp){
  const el=leads.filter(l=>l.owner===emp);
  const done=el.filter(l=>l.status==='Completed').length,lost=el.filter(l=>l.status==='Lost').length;
  const rate=el.length?Math.round(done/el.length*100):0,v=el.reduce((s,l)=>s+(l.value||0),0);
  const sm={};el.forEach(l=>sm[l.source]=(sm[l.source]||0)+1);const top=Object.entries(sm).sort((a,b)=>b[1]-a[1])[0];
  return `<div class="pc"><div class="pc-top"><div class="av">${emp[0]}</div><div><div class="pc-name">${emp}</div><div class="pc-role">Logistics Executive</div></div></div><div class="pc-nums"><div class="pn"><div class="pn-v">${el.length}</div><div class="pn-l">Leads</div></div><div class="pn"><div class="pn-v" style="color:var(--green)">${done}</div><div class="pn-l">Closed</div></div><div class="pn"><div class="pn-v" style="color:var(--red)">${lost}</div><div class="pn-l">Lost</div></div></div><div class="pw"><div class="pw-h"><span style="font-size:.65rem;color:var(--t3)">Conv.</span><span style="font-size:.65rem;font-family:'JetBrains Mono',monospace;color:var(--accent)">${rate}%</span></div><div class="pw-t"><div class="pw-f" style="width:${rate}%"></div></div></div><div style="font-size:.67rem;color:var(--t3);margin-top:.28rem">₹${(v/1000).toFixed(0)}K${top?' · '+top[0]:''}</div></div>`;
}

/* ════════════════════════════════════════════
   ALL LEADS with bulk select
════════════════════════════════════════════ */
window.renderLeads=function(){
  const ft=window._fText,fs=window._fSt;
  const list=leads.filter(l=>(!ft||[l.client,l.origin,l.dest].some(s=>(s||'').toLowerCase().includes(ft.toLowerCase())))&&(!fs||l.status===fs));
  ge('lc').textContent=`(${list.length})`;
  const tb=ge('leads-tb');
  if(!list.length){tb.innerHTML=`<tr><td colspan="11">${emptyRow()}</td></tr>`;return;}
  tb.innerHTML=list.map(l=>{
    const cs=collabsOf(l),pend=(l.accessRequests||[]).filter(r=>r.status==='pending').length,ed=canEdit(l);
    const stag=isStagnant(l)&&l.status!=='Completed'&&l.status!=='Lost';
    const sel=selectedLeads.has(l.id);
    return `<tr style="${stag?'background:#fffbeb':''}" ${sel?'class="selected-row"':''}>
      <td><input type="checkbox" ${sel?'checked':''} onchange="window.toggleSelect('${l.id}',this.checked)"></td>
      <td><span class="mono">${l.id?.slice(-8)||'—'}</span>${stag?`<span style="margin-left:.3rem;font-size:.55rem;background:var(--amd);color:var(--amber);padding:.06rem .28rem;border-radius:3px;font-weight:700">48h</span>`:''}</td>
      <td><div style="font-weight:600">${l.client}</div><div style="font-size:.66rem;color:var(--t3)">${l.contact||''}</div></td>
      <td style="font-size:.74rem">${l.origin}<br><span style="color:var(--t3)">→ ${l.dest}</span></td>
      <td>${bdg(l.mode,MC[l.mode]||'bs')}</td>
      <td style="font-size:.73rem;color:var(--t2)">${l.source}</td>
      <td>${bdg(l.status,SC[l.status]||'bs')}</td>
      <td class="mono">${money(l.value)}</td>
      <td style="font-size:.74rem">${l.owner}</td>
      <td style="font-size:.68rem;color:var(--t3)">${timeAgo(l.lastActivity)}</td>
      <td><div class="ab">
        <button class="bi" title="View" onclick="window.viewLead('${l.id}')">▶</button>
        ${ed?`<button class="bi" title="Edit" onclick="window.editLead('${l.id}')">✎</button>
              <button class="bi" title="Log Call" onclick="window.openCallLog('${l.id}')" style="font-size:.65rem">📞</button>
              <button class="bi cal" title="Follow-up" onclick="window.openFollowUp('${l.id}')">🗓</button>
              <button class="bi wa" title="WhatsApp" onclick="window.sendWhatsApp('${l.id}')">💬</button>
              <button class="bi" title="Attach Docs" onclick="window.openDocAttach('${l.id}')" style="font-size:.65rem">📎</button>
              <button class="bi" title="Quote" onclick="window.openQuote('${l.id}')">$</button>`:''
        }
        <button class="bi" title="Share" onclick="window.openShare('${l.id}')">↗</button>
        ${userProfile.role==='admin'?`<button class="bi del" onclick="window.delLead('${l.id}')">&times;</button>`:''}
      </div></td>
    </tr>`;
  }).join('');

  // Update bulk assign dropdown
  const bas=ge('bulk-assign-sel');
  if(bas){
    const emps=[...new Set(leads.map(l=>l.owner))];
    bas.innerHTML='<option value="">Reassign to…</option>'+emps.map(e=>`<option>${e}</option>`).join('');
  }
};
function renderLeads(){window.renderLeads();}

/* ════════════════════════════════════════════
   BULK SELECT
════════════════════════════════════════════ */
window.toggleSelect=function(id,checked){
  if(checked)selectedLeads.add(id);else selectedLeads.delete(id);
  updateBulkBar();
};
window.toggleSelectAll=function(){
  const chkAll=ge('chk-all');
  const ft=window._fText,fs=window._fSt;
  const list=leads.filter(l=>(!ft||[l.client,l.origin,l.dest].some(s=>(s||'').toLowerCase().includes(ft.toLowerCase())))&&(!fs||l.status===fs));
  if(selectedLeads.size===list.length){selectedLeads.clear();}
  else{list.forEach(l=>selectedLeads.add(l.id));}
  window.renderLeads();updateBulkBar();
};
function updateBulkBar(){
  const bar=ge('bulk-bar'),cnt=ge('bulk-count');
  if(selectedLeads.size>0){bar.classList.add('show');cnt.textContent=selectedLeads.size+' lead'+( selectedLeads.size!==1?'s':'')+' selected';}
  else{bar.classList.remove('show');}
}
window.clearBulk=function(){selectedLeads.clear();window.renderLeads();updateBulkBar();};
window.bulkChangeStatus=async function(){
  const st=val('bulk-status-sel');if(!st)return toast('Select a status','warn');
  if(!selectedLeads.size)return;
  const promises=[...selectedLeads].map(id=>updateDoc(doc(db,'leads',id),{status:st,lastActivity:now()}));
  await Promise.all(promises);
  await writeAudit('Status Changed','bulk','Multiple',`Bulk set to "${st}" — ${selectedLeads.size} leads`);
  window.clearBulk();toast(`${selectedLeads.size} leads → ${st}`,'ok');
};
window.bulkReassign=async function(){
  const emp=ge('bulk-assign-sel').value;if(!emp)return toast('Select an employee','warn');
  const promises=[...selectedLeads].map(id=>updateDoc(doc(db,'leads',id),{owner:emp,lastActivity:now()}));
  await Promise.all(promises);
  await writeAudit('Reassigned','bulk','Multiple',`Bulk reassigned to ${emp} — ${selectedLeads.size} leads`);
  window.clearBulk();toast(`Reassigned to ${emp}`,'ok');
};
window.bulkDelete=async function(){
  if(!confirm(`Delete ${selectedLeads.size} leads permanently?`))return;
  const promises=[...selectedLeads].map(id=>deleteDoc(doc(db,'leads',id)));
  await Promise.all(promises);
  window.clearBulk();toast('Leads deleted','ok');
};

/* ════════════════════════════════════════════
   KANBAN
════════════════════════════════════════════ */
function renderKanban(){
  const statuses=['Submitted','Quoted','Accepted','Completed','Lost'];
  const board=ge('kanban-board');
  board.innerHTML=statuses.map(st=>{
    const col=leads.filter(l=>l.status===st);
    const val=col.reduce((s,l)=>s+(l.value||0),0);
    return `<div class="kb-col" data-status="${st}" ondragover="event.preventDefault()" ondrop="window.onKanbanDrop(event,'${st}')">
      <div class="kb-col-head">
        <div class="kb-title">${st}</div>
        <div class="kb-cnt">${col.length} · ${money(val)}</div>
      </div>
      ${col.map(l=>`<div class="kb-card" draggable="true" data-id="${l.id}"
        ondragstart="window.onKanbanDragStart(event,'${l.id}')"
        ondragend="window.onKanbanDragEnd(event)"
        ondragenter="this.classList.add('drag-over')"
        ondragleave="this.classList.remove('drag-over')"
        onclick="window.viewLead('${l.id}')">
        <div class="kb-client">${l.client}</div>
        <div class="kb-route">${l.origin} → ${l.dest} · ${l.mode}</div>
        <div class="kb-foot">
          <div class="kb-val">${money(l.value)}</div>
          <div class="kb-owner">${l.owner}</div>
        </div>
      </div>`).join('')}
    </div>`;
  }).join('');
}
let dragId=null;
window.onKanbanDragStart=function(e,id){dragId=id;e.currentTarget.classList.add('dragging');}; 
window.onKanbanDragEnd=function(e){e.currentTarget.classList.remove('dragging');document.querySelectorAll('.kb-card.drag-over').forEach(c=>c.classList.remove('drag-over'));};
window.onKanbanDrop=async function(e,newStatus){
  e.preventDefault();
  if(!dragId)return;
  const l=leads.find(x=>x.id===dragId);if(!l||l.status===newStatus)return;
  const oldStatus=l.status;
  try{
    await updateDoc(doc(db,'leads',dragId),{status:newStatus,lastActivity:now()});
    await writeAudit('Status Changed',dragId,l.client,`${oldStatus} → ${newStatus}`);
    toast(`${l.client} → ${newStatus}`,'ok');
  }catch(err){toast(err.message,'err');}
  dragId=null;
};

/* ════════════════════════════════════════════
   CLIENT ACCOUNTS (grouped view)
════════════════════════════════════════════ */
window.renderAccounts=function(filter=''){
  const grouped={};
  leads.forEach(l=>{
    const key=l.client.toLowerCase();
    if(!grouped[key])grouped[key]={client:l.client,contact:l.contact||'',leads:[]};
    grouped[key].leads.push(l);
  });
  const list=Object.values(grouped).filter(a=>!filter||a.client.toLowerCase().includes(filter.toLowerCase())).sort((a,b)=>b.leads.length-a.leads.length);
  ge('acct-count').textContent=`(${list.length} clients)`;
  if(!list.length){ge('acct-grid').innerHTML=`<div class="empty">No clients yet.</div>`;return;}
  ge('acct-grid').innerHTML=list.map(a=>{
    const totalVal=a.leads.reduce((s,l)=>s+(l.value||0),0);
    const active=a.leads.filter(l=>!['Completed','Lost'].includes(l.status)).length;
    const done=a.leads.filter(l=>l.status==='Completed').length;
    const st={};a.leads.forEach(l=>st[l.status]=(st[l.status]||0)+1);
    return `<div class="acct-card" onclick="window.openAccountDetail('${encodeURIComponent(a.client)}')">
      <div class="acct-top">
        <div class="acct-av">${a.client[0].toUpperCase()}</div>
        <div>
          <div class="acct-name">${a.client}</div>
          <div class="acct-contact">${a.contact||'No contact recorded'}</div>
        </div>
      </div>
      <div class="acct-nums">
        <div><div class="acct-num-v">${a.leads.length}</div><div class="acct-num-l">Total</div></div>
        <div><div class="acct-num-v" style="color:var(--accent)">${active}</div><div class="acct-num-l">Active</div></div>
        <div><div class="acct-num-v" style="color:var(--green)">${done}</div><div class="acct-num-l">Closed</div></div>
      </div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--accent);font-weight:700;margin-top:.5rem">${money(totalVal)} total value</div>
      <div class="acct-statuses">${Object.entries(st).map(([k,v])=>`${bdg(k+' '+v,SC[k]||'bs')}`).join('')}</div>
    </div>`;
  }).join('');
};
window.openAccountDetail=function(clientEncoded){
  const client=decodeURIComponent(clientEncoded);
  const cl=leads.filter(l=>l.client.toLowerCase()===client.toLowerCase());
  if(!cl.length)return;
  // Show in detail modal as account view
  ge('md-t').textContent=client+' — Account History ('+cl.length+' leads)';
  ge('md-b').innerHTML=`
    <div style="display:flex;gap:.65rem;margin-bottom:1rem">
      <div class="sc" style="flex:1"><div class="sc-v">${cl.length}</div><div class="sc-l">Total Leads</div></div>
      <div class="sc" style="flex:1"><div class="sc-v" style="color:var(--green)">${cl.filter(l=>l.status==='Completed').length}</div><div class="sc-l">Completed</div></div>
      <div class="sc" style="flex:1"><div class="sc-v" style="color:var(--accent)">${money(cl.reduce((s,l)=>s+(l.value||0),0))}</div><div class="sc-l">Total Value</div></div>
    </div>
    ${cl.map(l=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:.58rem .75rem;background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:.35rem">
      <div>
        <div style="font-size:.78rem;font-weight:600">${l.origin} → ${l.dest} · ${l.mode}</div>
        <div style="font-size:.65rem;color:var(--t3)">${l.id?.slice(-8)} · ${l.owner} · ${timeAgo(l.createdAt?.toDate?.()?.toISOString())}</div>
      </div>
      <div style="display:flex;align-items:center;gap:.45rem">
        ${bdg(l.status,SC[l.status]||'bs')}
        <span class="mono">${money(l.value)}</span>
        <button class="bi" onclick="window.closeM('m-detail');setTimeout(()=>window.viewLead('${l.id}'),100)">▶</button>
      </div>
    </div>`).join('')}
  `;
  window.openM('m-detail');
};

/* ════════════════════════════════════════════
   AUDIT LOG
════════════════════════════════════════════ */
function renderAudit(filter=''){
  const logs=filter?auditLogs.filter(l=>l.action===filter):auditLogs;
  const icons={Created:'<polyline points="12 5 12 19 5 12 19 12"/>',Updated:'<path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>','Status Changed':'<polyline points="20 6 9 17 4 12"/>',Deleted:'<polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/>','Quote Added':'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>',Reassigned:'<path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14"/>'};
  const colors={Created:'var(--green)',Updated:'var(--accent)','Status Changed':'var(--violet)',Deleted:'var(--red)','Quote Added':'var(--amber)',Reassigned:'var(--teal)'};
  ge('audit-list').innerHTML=logs.length?logs.slice(0,100).map(l=>`
    <div class="audit-row">
      <div class="audit-dot" style="background:${colors[l.action]||'var(--t3)'}22;border-color:${colors[l.action]||'var(--t3)'}">
        <svg viewBox="0 0 24 24" fill="none" stroke="${colors[l.action]||'var(--t3)'}" stroke-width="2.5" stroke-linecap="round" width="9" height="9">${icons[l.action]||''}</svg>
      </div>
      <div class="audit-body">
        <div class="audit-text"><b>${l.by}</b> ${l.action.toLowerCase()} <b>${l.client}</b> — ${l.details||''}</div>
        <div class="audit-meta">${l.leadId?.slice(-8)||''} · ${new Date(l.ts).toLocaleString('en-IN',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</div>
      </div>
    </div>`).join(''):`<div class="empty">No audit entries yet.</div>`;
}
window.filterAudit=function(v){renderAudit(v);};

/* ════════════════════════════════════════════
   MY WORK with daily todo
════════════════════════════════════════════ */
function renderMyWork(){
  // Daily focus — leads that need action today
  const mine=leads.filter(l=>l.ownerUid===currentUser.uid);
  const focus=mine.filter(l=>!['Completed','Lost'].includes(l.status)).slice(0,5);
  const tc=ge('todo-cards');
  if(tc){
    tc.innerHTML=focus.length?focus.map(l=>`
      <div class="todo-card" id="td-${l.id}">
        <div class="todo-chk" id="tdc-${l.id}" onclick="window.toggleTodo('${l.id}')">
          <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="todo-info">
          <div class="todo-client">${l.client}</div>
          <div class="todo-action">${l.status==='Submitted'?'Send quote':'Follow up'} · ${l.origin} → ${l.dest}</div>
          <div class="todo-due">${bdg(l.status,SC[l.status]||'bs')} ${money(l.value)}</div>
        </div>
      </div>`).join(''):`<div style="font-size:.78rem;color:var(--t3);padding:.5rem 0">All clear — no pending leads today.</div>`;
  }

  ge('my-tb').innerHTML=mine.length?mine.map(l=>{const cs=collabsOf(l),pend=(l.accessRequests||[]).filter(r=>r.status==='pending').length;
    return `<tr><td><span class="mono">${l.id?.slice(-8)||'—'}</span></td><td style="font-weight:600">${l.client}</td><td style="font-size:.74rem">${l.origin} → ${l.dest}</td><td>${bdg(l.mode,MC[l.mode]||'bs')}</td><td>${bdg(l.status,SC[l.status]||'bs')}</td><td class="mono">${money(l.value)}</td><td style="font-size:.68rem;color:var(--t3)">${timeAgo(l.lastActivity)}</td><td>${cs.map(c=>`<span class="chip">${c.name.split(' ')[0]}</span>`).join('')||'<span style="font-size:.66rem;color:var(--t3)">None</span>'}</td><td>${pend?`<button class="btn btn-sm btn-amber" onclick="window.openShare('${l.id}')">${pend} pending</button>`:'<span style="font-size:.66rem;color:var(--t3)">—</span>'}</td>
    <td><div class="ab"><button class="bi" onclick="window.viewLead('${l.id}')">▶</button><button class="bi" onclick="window.editLead('${l.id}')">✎</button><button class="bi" title="Log Call" onclick="window.openCallLog('${l.id}')" style="font-size:.65rem">📞</button><button class="bi cal" title="Follow-up" onclick="window.openFollowUp('${l.id}')">🗓</button><button class="bi wa" title="WhatsApp" onclick="window.sendWhatsApp('${l.id}')">💬</button><button class="bi" onclick="window.openQuote('${l.id}')">$</button><button class="bi" onclick="window.openShare('${l.id}')">↗</button></div></td></tr>`;
  }).join(''):`<tr><td colspan="10">${emptyRow('No leads yet. Create your first!')}</td></tr>`;

  const collab=leads.filter(l=>l.ownerUid!==currentUser.uid&&((l.invitees||[]).includes(userProfile.name)||(l.accessRequests||[]).some(r=>r.by===userProfile.name&&r.status==='approved')));
  ge('col-tb').innerHTML=collab.length?collab.map(l=>`<tr><td><span class="mono">${l.id?.slice(-8)||'—'}</span></td><td style="font-weight:600">${l.client}</td><td style="font-size:.74rem">${l.origin} → ${l.dest}</td><td>${bdg(l.status,SC[l.status]||'bs')}</td><td style="font-size:.74rem">${l.owner}</td><td>${myAccess(l)}</td><td><div class="ab"><button class="bi" onclick="window.viewLead('${l.id}')">▶</button><button class="bi" onclick="window.editLead('${l.id}')">✎</button><button class="bi" onclick="window.openQuote('${l.id}')">$</button></div></td></tr>`).join(''):`<tr><td colspan="7">${emptyRow('No shared leads.')}</td></tr>`;
}

window.toggleTodo=function(id){
  const chk=ge('tdc-'+id),card=ge('td-'+id);
  chk.classList.toggle('checked');
  card.classList.toggle('done-card');
  toast('Marked done ✓','ok');
};

window.renderDiscover=function(){
  const ft=window._fdText,fs=window._fdSt;
  const list=leads.filter(l=>(!ft||[l.client,l.origin,l.dest].some(s=>(s||'').toLowerCase().includes(ft.toLowerCase())))&&(!fs||l.status===fs));
  ge('disc-tb').innerHTML=list.length?list.map(l=>{
    const isOwner=l.ownerUid===currentUser.uid,inv=(l.invitees||[]).includes(userProfile.name);
    const req=(l.accessRequests||[]).find(r=>r.by===userProfile.name);
    const approved=req?.status==='approved',pending=req?.status==='pending';
    let acc,act;
    if(isOwner){acc='<span class="chip">Owner</span>';act=`<button class="bi" onclick="window.viewLead('${l.id}')">▶</button>`;}
    else if(inv||approved){acc=`<span class="chip">${inv?'Invited':'Approved'}</span>`;act=`<button class="bi" onclick="window.viewLead('${l.id}')">▶</button><button class="bi" onclick="window.editLead('${l.id}')">✎</button>`;}
    else if(pending){acc='<span class="chip chip-wait">Requested</span>';act=`<button class="bi" onclick="window.viewLead('${l.id}')">▶</button>`;}
    else{acc='<span class="chip chip-view">View only</span>';act=`<button class="bi" onclick="window.viewLead('${l.id}')">▶</button><button class="btn btn-sm btn-outline" onclick="window.openReqAccess('${l.id}')">Request Access</button>`;}
    return `<tr><td><span class="mono">${l.id?.slice(-8)||'—'}</span></td><td style="font-weight:600">${l.client}</td><td style="font-size:.74rem">${l.origin} → ${l.dest}</td><td>${bdg(l.mode,MC[l.mode]||'bs')}</td><td>${bdg(l.status,SC[l.status]||'bs')}</td><td style="font-size:.74rem">${l.owner}</td><td>${acc}</td><td><div class="ab">${act}</div></td></tr>`;
  }).join(''):`<tr><td colspan="8">${emptyRow()}</td></tr>`;
};
function renderDiscover(){window.renderDiscover();}

function renderNotifs(){
  let items=[];const isAdmin=userProfile.role==='admin';
  leads.forEach(l=>{
    const isOwner=l.ownerUid===currentUser.uid||isAdmin;
    (l.accessRequests||[]).filter(r=>r.status==='pending'&&isOwner).forEach(r=>items.push({t:'req',l,r}));
    (l.accessRequests||[]).filter(r=>r.by===userProfile.name&&r.status!=='pending').forEach(r=>items.push({t:'res',l,r}));
    if((l.invitees||[]).includes(userProfile.name))items.push({t:'inv',l});
    // Mention notifications
    if((l.mentions||[]).includes(userProfile.name)&&(isOwner||canEdit(l)))items.push({t:'mention',l});
  });
  const seen=new Set();items=items.filter(x=>{const k=x.t+x.l.id+(x.r?.by||'');if(seen.has(k))return false;seen.add(k);return true;});
  ge('notif-list').innerHTML=items.length?items.map(x=>{
    if(x.t==='req')return `<div class="nc urgent"><div class="ni ni-amber"><svg viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/><line x1="19" y1="11" x2="19" y2="17"/><line x1="16" y1="14" x2="22" y2="14"/></svg></div><div class="nb"><div class="nb-t"><b>${x.r.by}</b> requests edit access to "${x.l.client}"</div><div class="nb-m">${x.l.id?.slice(-8)} · ${x.l.origin} → ${x.l.dest} · ${x.r.date}</div><div class="nb-m">Reason: <em>"${x.r.reason||'Not specified'}"</em></div><div class="nb-a"><button class="btn btn-sm btn-green" onclick="window.resolveReq('${x.l.id}','${x.r.by}','approved')">Approve</button><button class="btn btn-sm btn-red" onclick="window.resolveReq('${x.l.id}','${x.r.by}','rejected')">Reject</button><button class="btn btn-sm btn-ghost" onclick="window.viewLead('${x.l.id}')">View Lead</button></div></div></div>`;
    if(x.t==='res'){const ok=x.r.status==='approved';return `<div class="nc"><div class="ni" style="background:${ok?'var(--gd)':'var(--rd)'}"><svg viewBox="0 0 24 24" fill="none" stroke="${ok?'var(--green)':'var(--red)'}" stroke-width="2.5" stroke-linecap="round">${ok?'<polyline points="20 6 9 17 4 12"/>':'<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'}</svg></div><div class="nb"><div class="nb-t">Your request was <b style="color:${ok?'var(--green)':'var(--red)'}">${x.r.status}</b></div><div class="nb-m">${x.l.client} · ${x.l.origin} → ${x.l.dest}</div>${ok?`<div class="nb-a"><button class="btn btn-sm btn-outline" onclick="window.editLead('${x.l.id}')">Open Lead</button></div>`:''}</div></div>`;}
    if(x.t==='inv')return `<div class="nc"><div class="ni ni-blue"><svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07"/><path d="M16 11.37A4 4 0 1112.63 8"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg></div><div class="nb"><div class="nb-t">Invited to collaborate on <b>"${x.l.client}"</b></div><div class="nb-m">Owner: ${x.l.owner} · ${x.l.origin} → ${x.l.dest}</div><div class="nb-a"><button class="btn btn-sm btn-blue" onclick="window.editLead('${x.l.id}')">Open Lead</button></div></div></div>`;
    if(x.t==='mention')return `<div class="nc urgent"><div class="ni" style="background:var(--vd)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--violet)" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg></div><div class="nb"><div class="nb-t">You were @mentioned in <b>"${x.l.client}"</b></div><div class="nb-m">Lead by ${x.l.owner}</div><div class="nb-a"><button class="btn btn-sm btn-blue" onclick="window.viewLead('${x.l.id}')">View Lead</button></div></div></div>`;
    return '';
  }).join(''):`<div class="empty">No notifications.</div>`;
}

function renderReports(){ge('rep-grid').innerHTML=[...new Set(leads.map(l=>l.owner))].slice(0,6).map(perfCard).join('');}

function renderMyAna(){
  const ml=leads.filter(l=>l.ownerUid===currentUser.uid);
  const done=ml.filter(l=>l.status==='Completed').length,rate=ml.length?Math.round(done/ml.length*100):0;
  const v=ml.reduce((s,l)=>s+(l.value||0),0);
  ge('my-stats').innerHTML=[{v:ml.length,l:'My Leads'},{v:done,l:'Completed'},{v:rate+'%',l:'Conv. Rate'},{v:'₹'+(v/1000).toFixed(0)+'K',l:'Pipeline'}].map(s=>`<div class="sc"><div class="sc-v">${s.v}</div><div class="sc-l">${s.l}</div></div>`).join('');
  const st={Submitted:0,Quoted:0,Accepted:0,Completed:0,Lost:0},mo={Air:0,Sea:0,Road:0,Multimodal:0};
  ml.forEach(l=>{st[l.status]=(st[l.status]||0)+1;mo[l.mode]=(mo[l.mode]||0)+1;});
  const maxS=Math.max(...Object.values(st),1),maxM=Math.max(...Object.values(mo),1);
  ge('my-s').innerHTML=Object.entries(st).map(([k,v])=>`<div class="br"><div class="br-l">${k}</div><div class="brt"><div class="brf" style="width:${v/maxS*100}%;background:${SCC[k]}"></div></div><div class="br-n">${v}</div></div>`).join('');
  const mc={Air:'var(--violet)',Sea:'var(--teal)',Road:'var(--amber)',Multimodal:'var(--green)'};
  ge('my-m').innerHTML=Object.entries(mo).map(([k,v])=>`<div class="br"><div class="br-l">${k}</div><div class="brt"><div class="brf" style="width:${v/maxM*100}%;background:${mc[k]}"></div></div><div class="br-n">${v}</div></div>`).join('');
}

/* ════════════════════════════════════════════
   AUTO-SUGGEST + DUPLICATE DETECTION
════════════════════════════════════════════ */
window.onClientInput=function(v){
  const drop=ge('client-suggest');
  if(!v||v.length<1){drop.classList.remove('open');return;}
  const grouped={};
  leads.forEach(l=>{const key=l.client.toLowerCase();if(!grouped[key])grouped[key]={name:l.client,contact:l.contact,count:0};grouped[key].count++;});
  const matches=Object.values(grouped).filter(g=>g.name.toLowerCase().includes(v.toLowerCase())).slice(0,8);
  if(!matches.length){drop.classList.remove('open');return;}
  drop.innerHTML=matches.map(m=>`<div class="sg-item" onmousedown="window.selectSuggest('${m.name.replace(/'/g,"\\'")}')">
    <div><div class="sg-item-name">${m.name}</div><div class="sg-item-meta">${m.contact||'No contact'}</div></div>
    <div class="sg-item-count">${m.count} lead${m.count!==1?'s':''}</div>
  </div>`).join('');
  drop.classList.add('open');
};
window.selectSuggest=function(name){
  ge('f-client').value=name;
  ge('client-suggest').classList.remove('open');
};
window.closeSuggest=function(){ge('client-suggest').classList.remove('open');};

window.checkDuplicate=function(v){
  if(!v||v.length<6){ge('dup-warn').classList.remove('show');dupClientId=null;return;}
  const match=leads.find(l=>l.contact&&(l.contact.replace(/\s/g,'')).includes(v.replace(/\s/g,'')));
  if(match&&match.id!==editingLeadId){
    dupClientId=match.id;
    ge('dup-msg').textContent=`⚠ "${match.client}" already has this contact. Duplicate?`;
    ge('dup-warn').classList.add('show');
  }else{ge('dup-warn').classList.remove('show');dupClientId=null;}
};
window.viewDuplicateClient=function(){
  if(!dupClientId)return;
  window.closeM('m-lead');
  setTimeout(()=>window.viewLead(dupClientId),100);
};

/* ════════════════════════════════════════════
   @MENTION SYSTEM
════════════════════════════════════════════ */
let mentionQuery='',mentionStart=-1;
window.onNotesInput=function(e){
  const ta=e.target,text=ta.value,pos=ta.selectionStart;
  const before=text.slice(0,pos);
  const atIdx=before.lastIndexOf('@');
  if(atIdx>=0){
    mentionQuery=before.slice(atIdx+1).toLowerCase();
    mentionStart=atIdx;
    const candidates=allUsers.filter(u=>u.name.toLowerCase().includes(mentionQuery)&&u.name!==userProfile.name).slice(0,5);
    if(candidates.length){
      const drop=ge('mention-drop');
      drop.innerHTML=candidates.map(u=>`<div class="mention-item" onmousedown="window.insertMention('${u.name}')"><div class="mention-av">${u.name[0]}</div>${u.name} <span style="font-size:.62rem;color:var(--t3)">(${u.role})</span></div>`).join('');
      drop.style.display='block';
      drop.classList.add('open');
    }else{ge('mention-drop').classList.remove('open');}
  }else{ge('mention-drop').classList.remove('open');}
};
window.insertMention=function(name){
  const ta=ge('f-notes');
  const before=ta.value.slice(0,mentionStart);
  const after=ta.value.slice(ta.selectionStart);
  ta.value=before+'@'+name+' '+after;
  ge('mention-drop').classList.remove('open');
};
document.addEventListener('click',e=>{if(!e.target.closest('.mention-drop'))ge('mention-drop')?.classList.remove('open');});

/* ════════════════════════════════════════════
   QUICK CALL LOG
════════════════════════════════════════════ */
window.openCallLog=function(id){
  const l=leads.find(x=>x.id===id);if(!l)return;
  callLogLeadId=id;callOutcome='Reached';
  ge('ql-client').textContent=l.client;
  ge('ql-notes').value='';
  ['co-reached','co-vm','co-na'].forEach(i=>ge(i)?.classList.remove('btn-blue'));
  ge('co-reached').classList.add('btn-blue');
  ge('ql-panel').classList.add('open');
};
window.setCallOutcome=function(o){
  callOutcome=o;
  ['co-reached','co-vm','co-na'].forEach(i=>ge(i)?.classList.remove('btn-blue'));
  const map={'Reached':'co-reached','Voicemail':'co-vm','No Answer':'co-na'};
  ge(map[o])?.classList.add('btn-blue');
};
window.closeCallLog=function(){ge('ql-panel').classList.remove('open');callLogLeadId=null;};
window.saveCallLog=async function(){
  if(!callLogLeadId)return;
  const notes=ge('ql-notes').value.trim();
  const l=leads.find(x=>x.id===callLogLeadId);if(!l)return;
  const entry={outcome:callOutcome,notes,by:userProfile.name,ts:now()};
  try{
    await updateDoc(doc(db,'leads',callLogLeadId),{callLogs:arrayUnion(entry),lastActivity:now()});
    await writeAudit('Updated',callLogLeadId,l.client,`Call logged: ${callOutcome}${notes?' — '+notes.slice(0,40):''}`);
    window.closeCallLog();toast('Call logged','ok');
  }catch(e){toast(e.message,'err');}
};

/* ════════════════════════════════════════════
   FOLLOW-UP SCHEDULER
════════════════════════════════════════════ */
window.openFollowUp=function(id){
  const l=leads.find(x=>x.id===id);if(!l)return;
  followUpLeadId=id;
  ge('fu-client').textContent=l.client+' · '+l.origin+' → '+l.dest;
  const dt=new Date();dt.setDate(dt.getDate()+1);dt.setHours(10,0,0,0);
  ge('fu-date').value=dt.toISOString().slice(0,16);
  ge('fu-note').value='';
  window.openM('m-followup');
};
window.saveFollowUp=function(){
  const l=leads.find(x=>x.id===followUpLeadId);if(!l)return;
  const dt=ge('fu-date').value;const note=ge('fu-note').value||'Follow up on shipment';
  if(!dt)return toast('Pick a date and time','warn');
  const start=new Date(dt);
  const end=new Date(start.getTime()+30*60000);
  const fmt=d=>d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}/,'');
  const title=encodeURIComponent(`Follow-up: ${l.client} (${l.origin} → ${l.dest})`);
  const details=encodeURIComponent(note+'\n\nLead: '+l.id?.slice(-8)+' | '+l.cargo+' | '+money(l.value));
  const url=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${fmt(start)}/${fmt(end)}&details=${details}`;
  window.open(url,'_blank');
  window.closeM('m-followup');toast('Opening Google Calendar…','info');
};

/* ════════════════════════════════════════════
   WHATSAPP ONE-CLICK
════════════════════════════════════════════ */
window.sendWhatsApp=function(id){
  const l=leads.find(x=>x.id===id);if(!l)return;
  const phone=(l.contact||'').replace(/[^0-9]/g,'');
  const msg=encodeURIComponent(`Hi ${l.client},\n\nI have the freight rates ready for your *${l.cargo}* shipment from *${l.origin}* to *${l.dest}*.\n\nWould you like me to walk you through the quote?\n\nBest regards,\n${userProfile.name}\nWort Logistics`);
  const url=phone?`https://wa.me/${phone.startsWith('91')?phone:'91'+phone}?text=${msg}`:`https://web.whatsapp.com/send?text=${msg}`;
  window.open(url,'_blank');
};

/* ════════════════════════════════════════════
   STAGNANT LEAD REASSIGN
════════════════════════════════════════════ */
window.openReassign=function(id){
  reassignLeadId=id;
  loadUsers().then(()=>{
    const sel=ge('reassign-to');
    const l=leads.find(x=>x.id===id);
    sel.innerHTML=allUsers.filter(u=>u.name!==l?.owner&&u.role==='employee').map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
    window.openM('m-reassign');
  });
};
window.doReassign=async function(){
  if(!reassignLeadId)return;
  const to=val('reassign-to');if(!to)return;
  const l=leads.find(x=>x.id===reassignLeadId);if(!l)return;
  try{
    await updateDoc(doc(db,'leads',reassignLeadId),{owner:to,ownerUid:'',lastActivity:now()});
    await writeAudit('Reassigned',reassignLeadId,l.client,`From ${l.owner} to ${to}`);
    window.closeM('m-reassign');toast(`Reassigned to ${to}`,'ok');
  }catch(e){toast(e.message,'err');}
};
/* ════════════════════════════════════════════
   COMMAND CENTER
════════════════════════════════════════════ */
let assignmentRules=JSON.parse(localStorage.getItem('wort_rules')||'[]');

window.switchCmdTab=function(tab){
  document.querySelectorAll('.cmd-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.cmd-pane').forEach(p=>p.classList.remove('active'));
  event.target.classList.add('active');
  ge('cmd-'+tab).classList.add('active');
  if(tab==='pipeline')renderHeatmap();
  if(tab==='speed')renderSpeedTracker();
  if(tab==='rules')renderRules();
};

function renderCommand(){renderHeatmap();}

/* — PIPELINE HEATMAP — */
function renderHeatmap(){
  const STAGES=['Submitted','Quoted','Accepted','Completed','Lost'];
  const STALE_DAYS=5;
  const COLORS={Submitted:{bg:'#eff4ff',text:'#1a56db',bar:'#1a56db'},Quoted:{bg:'#fffbeb',text:'#c27803',bar:'#f59e0b'},Accepted:{bg:'#f5f3ff',text:'#7e3af2',bar:'#8b5cf6'},Completed:{bg:'#ecfdf5',text:'#0d9f6e',bar:'#10b981'},Lost:{bg:'#fef2f2',text:'#e02424',bar:'#ef4444'}};
  
  const hm=ge('heatmap-wrap');if(!hm)return;
  hm.innerHTML=STAGES.map(st=>{
    const sl=leads.filter(l=>l.status===st);
    const now=Date.now();
    const stale=sl.filter(l=>{
      const ts=l.lastActivity||l.createdAt?.toDate?.()?.toISOString();
      return ts&&(now-new Date(ts).getTime())>STALE_DAYS*86400000;
    });
    const val=sl.reduce((s,l)=>s+(l.value||0),0);
    const stalePct=sl.length?Math.round(stale.length/sl.length*100):0;
    const heat=stalePct>60?1:stalePct>30?.65:.35;
    const c=COLORS[st];
    return `<div class="hm-stage" style="background:${c.bg};border-color:${c.bar}44;opacity:${heat<=.35?1:stalePct>60?1:.85}">
      <div class="hm-stage-title" style="color:${c.text}">${st}</div>
      <div class="hm-count" style="color:${c.text}">${sl.length}</div>
      <div class="hm-days" style="color:${c.text}88">₹${(val/100000).toFixed(1)}L value</div>
      <div class="hm-bar" style="background:${c.bar}33"><div style="width:${stalePct}%;background:${c.bar};height:5px;border-radius:100px;transition:width .6s"></div></div>
      <div class="hm-stuck" style="background:${stalePct>30?c.bar+'22':'transparent'};color:${stalePct>30?c.text:'#9ba4be'}">${stale.length} stuck >${STALE_DAYS}d${stalePct>50?' ⚠':''}</div>
    </div>`;
  }).join('');

  // Stuck list
  const allStuck=leads.filter(l=>{
    if(['Completed','Lost'].includes(l.status))return false;
    const ts=l.lastActivity||l.createdAt?.toDate?.()?.toISOString();
    return ts&&(Date.now()-new Date(ts).getTime())>STALE_DAYS*86400000;
  }).sort((a,b)=>{
    const ta=a.lastActivity||a.createdAt?.toDate?.()?.toISOString()||'';
    const tb=b.lastActivity||b.createdAt?.toDate?.()?.toISOString()||'';
    return new Date(ta)-new Date(tb);
  });
  const sl2=ge('stuck-list');
  sl2.innerHTML=allStuck.length?allStuck.slice(0,8).map(l=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.48rem .65rem;background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:.32rem">
      <div>
        <div style="font-size:.77rem;font-weight:600">${l.client}</div>
        <div style="font-size:.62rem;color:var(--t3)">${l.owner} · ${bdg(l.status,SC[l.status]||'bs')} · ${timeAgo(l.lastActivity)}</div>
      </div>
      <div style="display:flex;gap:.28rem">
        <button class="btn btn-sm btn-amber" onclick="window.openReassign('${l.id}')">Reassign</button>
        <button class="btn btn-sm btn-ghost" onclick="window.viewLead('${l.id}')">▶</button>
      </div>
    </div>`).join(''):`<div style="font-size:.75rem;color:var(--green);padding:.5rem 0">✓ No leads stuck for more than ${STALE_DAYS} days</div>`;

  // Risk bars
  const rb=ge('risk-bars');
  const stageVal={};
  leads.forEach(l=>{if(!['Completed','Lost'].includes(l.status))stageVal[l.status]=(stageVal[l.status]||0)+(l.value||0);});
  const maxV=Math.max(...Object.values(stageVal),1);
  rb.innerHTML=Object.entries(stageVal).map(([k,v])=>`
    <div class="br">
      <div class="br-l">${k}</div>
      <div class="brt"><div class="brf" style="width:${v/maxV*100}%;background:${SCC[k]}"></div></div>
      <div style="font-size:.66rem;font-family:'JetBrains Mono',monospace;color:var(--t3);min-width:48px;text-align:right">₹${(v/100000).toFixed(1)}L</div>
    </div>`).join('');
}

/* — SPEED OF RESPONSE — */
function renderSpeedTracker(){
  const empData={};
  leads.forEach(l=>{
    const name=l.owner;
    if(!empData[name])empData[name]={name,times:[],leads:0,fast:null,slow:null};
    empData[name].leads++;
    const qs=l.quotes||[];
    if(qs.length&&l.createdAt?.toDate){
      const created=l.createdAt.toDate().getTime();
      const firstQ=new Date(qs[0].date).getTime();
      const hrs=(firstQ-created)/3600000;
      if(hrs>0&&hrs<720){
        empData[name].times.push(hrs);
        if(empData[name].fast===null||hrs<empData[name].fast)empData[name].fast=hrs;
        if(empData[name].slow===null||hrs>empData[name].slow)empData[name].slow=hrs;
      }
    }
  });

  const rows=Object.values(empData).map(e=>{
    const avg=e.times.length?e.times.reduce((a,b)=>a+b,0)/e.times.length:null;
    return{...e,avg};
  }).sort((a,b)=>(a.avg??9999)-(b.avg??9999));

  const maxAvg=Math.max(...rows.map(r=>r.avg||0),1);
  const fmtH=h=>{if(h===null)return'—';if(h<1)return Math.round(h*60)+'m';if(h<24)return h.toFixed(1)+'h';return(h/24).toFixed(1)+'d';};
  const grade=h=>{
    if(h===null)return{g:'N/A',bg:'var(--bg)',c:'var(--t3)'};
    if(h<4)return{g:'A+',bg:'var(--gd)',c:'var(--green)'};
    if(h<12)return{g:'A',bg:'#dcfce7',c:'var(--green)'};
    if(h<24)return{g:'B',bg:'var(--ad)',c:'var(--accent)'};
    if(h<72)return{g:'C',bg:'var(--amd)',c:'var(--amber)'};
    return{g:'D',bg:'var(--rd)',c:'var(--red)'};
  };

  const sr=ge('sor-rows');
  sr.innerHTML=rows.map(r=>{
    const g=grade(r.avg);
    return `<div class="sor-row">
      <div class="sor-emp"><div class="av" style="width:22px;height:22px;font-size:.6rem">${r.name[0]}</div>${r.name}</div>
      <div>
        <div style="font-size:.7rem;color:var(--t3);margin-bottom:.28rem">${r.avg?fmtH(r.avg)+' avg':r.leads+' leads, no quotes yet'}</div>
        <div class="sor-bar-wrap"><div class="sor-bar" style="width:${r.avg?r.avg/maxAvg*100:0}%;background:${g.c}"></div></div>
      </div>
      <div class="sor-val">${r.leads}</div>
      <div class="sor-val" style="color:var(--green)">${fmtH(r.fast)}</div>
      <div class="sor-val" style="color:var(--red)">${fmtH(r.slow)}</div>
      <div class="sor-val"><span class="sor-grade" style="background:${g.bg};color:${g.c}">${g.g}</span></div>
    </div>`;
  }).join('');

  // Benchmark
  const allTimes=rows.flatMap(r=>r.times);
  const teamAvg=allTimes.length?allTimes.reduce((a,b)=>a+b,0)/allTimes.length:null;
  const bc=ge('benchmark-content');
  bc.innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.65rem;margin-bottom:.82rem">
      <div class="pn" style="padding:.65rem"><div class="pn-v" style="color:var(--accent)">${fmtH(teamAvg)}</div><div class="pn-l">Team Avg Response</div></div>
      <div class="pn" style="padding:.65rem"><div class="pn-v" style="color:var(--green)">${fmtH(rows[0]?.avg??null)}</div><div class="pn-l">Fastest (${rows[0]?.name||'—'})</div></div>
      <div class="pn" style="padding:.65rem"><div class="pn-v" style="color:var(--red)">${fmtH(rows[rows.length-1]?.avg??null)}</div><div class="pn-l">Slowest (${rows[rows.length-1]?.name||'—'})</div></div>
    </div>
    <div style="font-size:.72rem;color:var(--t3);line-height:1.6">
      Grading: <b style="color:var(--green)">A+ &lt;4h</b> · <b style="color:var(--green)">A &lt;12h</b> · <b style="color:var(--accent)">B &lt;24h</b> · <b style="color:var(--amber)">C &lt;72h</b> · <b style="color:var(--red)">D ≥72h</b>
      <br>Note: Only leads with at least one quote are measured.
    </div>`;
}

/* — AUTO-ASSIGNMENT RULES — */
function renderRules(){
  loadUsers().then(()=>{
    // Populate assignee dropdown
    const asel=ge('rule-assignee');
    if(asel){
      const emp=allUsers.filter(u=>u.role==='employee');
      asel.innerHTML='<option value="__loadbalance__">Auto — Load Balance</option>'+emp.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
    }
  });

  const rl=ge('rule-list');
  const defaultRules=[
    {id:'r1',field:'dest',op:'contains',val:'USA',assignee:'__loadbalance__',priority:1,active:true,label:'US-bound leads — Load balance'},
    {id:'r2',field:'mode',op:'equals',val:'Air',assignee:'__loadbalance__',priority:2,active:true,label:'Air freight — Load balance'},
    {id:'r3',field:'value',op:'greater than',val:'500000',assignee:'__loadbalance__',priority:3,active:false,label:'High-value (>₹5L) — Load balance'},
  ];
  const rules=assignmentRules.length?assignmentRules:defaultRules;

  rl.innerHTML=rules.length?rules.map((r,i)=>`
    <div class="rule-card ${r.active?'active-rule':''}">
      <div class="rule-icon" style="background:${r.active?'var(--gd)':'var(--bg)'};color:${r.active?'var(--green)':'var(--t3)'}">
        <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      </div>
      <div class="rule-info">
        <div class="rule-title">IF <span style="color:var(--accent)">${r.field}</span> ${r.op} "<span style="color:var(--violet)">${r.val}</span>" → <span style="color:var(--green)">${r.assignee==='__loadbalance__'?'Auto Load Balance':r.assignee}</span></div>
        <div class="rule-desc">Priority ${r.priority} · ${r.active?'Active':'Disabled'}</div>
      </div>
      <label class="rule-toggle">
        <input type="checkbox" ${r.active?'checked':''} onchange="window.toggleRule(${i},this.checked)">
        <span class="rule-slider"></span>
      </label>
      <button class="btn btn-sm btn-ghost" onclick="window.deleteRule(${i})" style="color:var(--red)">✕</button>
    </div>`).join(''):`<div class="empty">No rules yet. Create one above.</div>`;

  // Load balance viz
  const lb=ge('loadbalance-viz');
  const emp={};
  leads.filter(l=>!['Completed','Lost'].includes(l.status)).forEach(l=>emp[l.owner]=(emp[l.owner]||0)+1);
  const sorted=Object.entries(emp).sort((a,b)=>a[1]-b[1]);
  const next=sorted[0]?.[0]||'(no employees yet)';
  lb.innerHTML=`
    <div class="ban ban-blue" style="margin-bottom:.65rem">Next auto-assigned lead goes to: <b>${next}</b> (${sorted[0]?.[1]||0} active leads)</div>
    ${sorted.map(([name,cnt],i)=>{
      const max=Math.max(...sorted.map(s=>s[1]),1);
      return `<div class="br" style="margin-bottom:.38rem"><div class="br-l">${name}</div><div class="brt"><div class="brf" style="width:${cnt/max*100}%;background:${cnt===sorted[0][1]?'var(--green)':cnt>sorted[sorted.length-1][1]*.7?'var(--amber)':'var(--accent)'}"></div></div><div style="font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--t3);width:55px;text-align:right">${cnt} active</div></div>`;
    }).join('')}`;
}

window.openRuleBuilder=function(){ge('rule-builder').style.display='block';ge('rule-builder').scrollIntoView({behavior:'smooth',block:'nearest'});};
window.closeRuleBuilder=function(){ge('rule-builder').style.display='none';};
window.updateRulePreview=function(){
  const f=ge('rule-field')?.value||'',op=ge('rule-op')?.value||'',v=ge('rule-val')?.value||'',a=ge('rule-assignee')?.value||'';
  ge('rule-preview').textContent=f&&v?`IF ${f} ${op} "${v}" → ${a==='__loadbalance__'?'Auto Load Balance':a||'(pick assignee)'}` :'Fill the fields above to preview';
};
window.saveRule=function(){
  const f=val('rule-field'),op=val('rule-op'),v=val('rule-val'),a=ge('rule-assignee')?.value||'__loadbalance__',p=val('rule-priority');
  if(!v)return toast('Enter a value to match','warn');
  const rule={id:'r'+Date.now(),field:f,op,val:v,assignee:a,priority:Number(p)||5,active:true};
  assignmentRules=[...assignmentRules,rule].sort((a,b)=>a.priority-b.priority);
  localStorage.setItem('wort_rules',JSON.stringify(assignmentRules));
  window.closeRuleBuilder();renderRules();toast('Rule saved','ok');
};
window.toggleRule=function(i,checked){
  const rules=assignmentRules.length?assignmentRules:[];
  if(rules[i])rules[i].active=checked;
  assignmentRules=rules;
  localStorage.setItem('wort_rules',JSON.stringify(rules));
  renderRules();toast(checked?'Rule activated':'Rule disabled',checked?'ok':'warn');
};
window.deleteRule=function(i){
  if(!confirm('Delete this rule?'))return;
  assignmentRules.splice(i,1);
  localStorage.setItem('wort_rules',JSON.stringify(assignmentRules));
  renderRules();toast('Rule deleted');
};

// Apply rules when creating a lead — call this before saveLead
function applyAssignmentRules(data){
  const rules=(assignmentRules.length?assignmentRules:[]).filter(r=>r.active).sort((a,b)=>a.priority-b.priority);
  for(const rule of rules){
    const fieldVal=(data[rule.field]||'').toString().toLowerCase();
    const matchVal=(rule.val||'').toLowerCase();
    let match=false;
    if(rule.op==='contains')match=fieldVal.includes(matchVal);
    else if(rule.op==='equals')match=fieldVal===matchVal;
    else if(rule.op==='starts with')match=fieldVal.startsWith(matchVal);
    else if(rule.op==='greater than')match=Number(data[rule.field])>Number(rule.val);
    if(match){
      if(rule.assignee==='__loadbalance__'){
        // Pick employee with fewest active leads
        const emp={};
        leads.filter(l=>!['Completed','Lost'].includes(l.status)).forEach(l=>emp[l.owner]=(emp[l.owner]||0)+1);
        const sorted=allUsers.filter(u=>u.role==='employee').map(u=>({name:u.name,cnt:emp[u.name]||0})).sort((a,b)=>a.cnt-b.cnt);
        if(sorted.length)return{assigned:sorted[0].name,rule:rule.field+' '+rule.op+' '+rule.val};
      }else{
        return{assigned:rule.assignee,rule:rule.field+' '+rule.op+' '+rule.val};
      }
    }
  }
  return null;
}

/* ════════════════════════════════════════════
   GLOBAL COMMAND BAR (Ctrl+K)
════════════════════════════════════════════ */
let cmdFocusIdx=-1;
window.openCmdBar=function(){
  ge('cmd-bar').classList.add('open');
  ge('cmd-input').value='';
  ge('cmd-input').focus();
  cmdFocusIdx=-1;
  window.cmdSearch('');
};
window.closeCmdBar=function(){ge('cmd-bar').classList.remove('open');};

document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();window.openCmdBar();}
  if(e.key==='Escape')window.closeCmdBar();
});

window.cmdSearch=function(q){
  const res=ge('cmd-results');
  if(!q){
    // Default quick actions
    res.innerHTML=`
      <div class="cmd-section-label">Quick Actions</div>
      <div class="cmd-result-item" tabindex="0" onclick="window.closeCmdBar();window.openCreate()"><div class="cri-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div><div class="cri-name">Create New Lead</div><div class="cri-meta">Open lead form</div></div>
      <div class="cmd-result-item" tabindex="0" onclick="window.closeCmdBar();window.goTo('kanban')"><div class="cri-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="12" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg></div><div class="cri-name">Open Kanban Board</div><div class="cri-meta">Pipeline drag & drop</div></div>
      ${userProfile?.role==='admin'?`<div class="cmd-result-item" tabindex="0" onclick="window.closeCmdBar();window.goTo('command')"><div class="cri-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div><div class="cri-name">Command Center</div><div class="cri-meta">Pipeline · Speed · Rules</div></div>`:''}
      <div class="cmd-result-item" tabindex="0" onclick="window.closeCmdBar();window.goTo('accounts')"><div class="cri-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div class="cri-name">Client Accounts</div><div class="cri-meta">Grouped client view</div></div>`;
    return;
  }
  const ql=q.toLowerCase();
  const matchLeads=leads.filter(l=>[l.client,l.origin,l.dest,l.cargo].some(s=>(s||'').toLowerCase().includes(ql))).slice(0,6);
  const matchClients=[...new Map(leads.filter(l=>(l.client||'').toLowerCase().includes(ql)).map(l=>[l.client,l])).values()].slice(0,4);

  let html='';
  if(matchLeads.length){
    html+=`<div class="cmd-section-label">Leads</div>`+matchLeads.map(l=>`
      <div class="cmd-result-item" onclick="window.closeCmdBar();window.viewLead('${l.id}')">
        <div class="cri-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/></svg></div>
        <div class="cri-name">${l.client}</div>
        <div class="cri-meta">${l.origin} → ${l.dest} · ${bdg(l.status,SC[l.status]||'bs')}</div>
      </div>`).join('');
  }
  if(matchClients.length){
    html+=`<div class="cmd-section-label">Clients</div>`+matchClients.map(l=>`
      <div class="cmd-result-item" onclick="window.closeCmdBar();window.goTo('accounts');setTimeout(()=>window.renderAccounts('${l.client}'),100)">
        <div class="cri-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
        <div class="cri-name">${l.client}</div>
        <div class="cri-meta">View all leads for this client</div>
      </div>`).join('');
  }
  res.innerHTML=html||`<div class="cmd-empty">No results for "${q}"</div>`;
};

window.cmdKeyNav=function(e){
  const items=ge('cmd-results').querySelectorAll('.cmd-result-item');
  if(e.key==='ArrowDown'){e.preventDefault();cmdFocusIdx=Math.min(cmdFocusIdx+1,items.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();cmdFocusIdx=Math.max(cmdFocusIdx-1,0);}
  else if(e.key==='Enter'&&cmdFocusIdx>=0){items[cmdFocusIdx].click();return;}
  items.forEach((el,i)=>el.classList.toggle('focused',i===cmdFocusIdx));
  items[cmdFocusIdx]?.scrollIntoView({block:'nearest'});
};

/* ════════════════════════════════════════════
   DOCUMENT ATTACHMENT
════════════════════════════════════════════ */
let docLeadId=null,selectedDocType='';

window.openDocAttach=function(id){
  const l=leads.find(x=>x.id===id);if(!l)return;
  docLeadId=id;selectedDocType='';
  ge('doc-lead-name').textContent=l.client;
  ge('doc-name').value='';ge('doc-link').value='';ge('doc-notes-inp').value='';
  document.querySelectorAll('.doc-type-btn').forEach(b=>b.classList.remove('sel'));
  renderDocList(l);
  window.openM('m-docs');
};
window.selectDocType=function(el,type){
  selectedDocType=type;
  document.querySelectorAll('.doc-type-btn').forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel');
};
function renderDocList(l){
  const docs=l.documents||[];
  ge('doc-attach-list').innerHTML=docs.length?docs.map((d,i)=>`
    <div class="doc-attach-item">
      <div class="doc-attach-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
      <div>
        <div class="doc-attach-name">${d.type} — ${d.name}</div>
        <div class="doc-attach-meta">By ${d.by} · ${timeAgo(d.ts)}${d.link?` · <a href="${d.link}" target="_blank" style="color:var(--accent)">Open →</a>`:''}</div>
        ${d.notes?`<div style="font-size:.62rem;color:var(--t3)">${d.notes}</div>`:''}
      </div>
      <button onclick="window.removeDoc('${docLeadId}',${i})" style="margin-left:auto;background:none;border:none;color:var(--t3);cursor:pointer;font-size:.75rem">✕</button>
    </div>`).join(''):`<div style="font-size:.73rem;color:var(--t3)">No documents attached yet.</div>`;
}
window.saveDoc=async function(){
  if(!docLeadId)return;
  if(!selectedDocType)return toast('Select a document type','warn');
  const name=val('doc-name');if(!name)return toast('Enter document name','err');
  const l=leads.find(x=>x.id===docLeadId);if(!l)return;
  const entry={type:selectedDocType,name,link:val('doc-link'),notes:val('doc-notes-inp'),by:userProfile.name,ts:now()};
  try{
    await updateDoc(doc(db,'leads',docLeadId),{documents:arrayUnion(entry),lastActivity:now()});
    await writeAudit('Updated',docLeadId,l.client,`Document attached: ${selectedDocType} — ${name}`);
    const updated=leads.find(x=>x.id===docLeadId);
    renderDocList({...l,documents:[...(l.documents||[]),entry]});
    ge('doc-name').value='';ge('doc-link').value='';ge('doc-notes-inp').value='';
    document.querySelectorAll('.doc-type-btn').forEach(b=>b.classList.remove('sel'));
    selectedDocType='';
    toast('Document attached','ok');
  }catch(e){toast(e.message,'err');}
};
window.removeDoc=async function(leadId,idx){
  const l=leads.find(x=>x.id===leadId);if(!l)return;
  const docs=[...(l.documents||[])];docs.splice(idx,1);
  try{
    await updateDoc(doc(db,'leads',leadId),{documents:docs});
    renderDocList({...l,documents:docs});toast('Document removed');
  }catch(e){toast(e.message,'err');}
};

// Wire doc attach into lead detail view  
window.openDocFromDetail=function(id){window.closeM('m-detail');setTimeout(()=>window.openDocAttach(id),120);};

/* PATCH saveLead to apply auto-assignment rules */
const _origSaveLead=window.saveLead;
window.saveLead=async function(){
  // If creating new lead, apply rules first
  if(!editingLeadId&&allUsers.length){
    const data={
      origin:val('f-origin'),dest:val('f-dest'),mode:val('f-mode'),
      source:val('f-src'),value:Number(val('f-value'))||0
    };
    const result=applyAssignmentRules(data);
    if(result){
      toast(`Auto-assigned to ${result.assigned} (rule: ${result.rule})`,'info');
      // We can't override owner here easily — handled inside original fn
      window._autoAssignedTo=result.assigned;
    }else{
      window._autoAssignedTo=null;
    }
  }
  await _origSaveLead();
};

window.showAllStagnant=function(){window.goTo('leads');window._fSt='';window._fText='';window.renderLeads();};

/* ════════════════════════════════════════════
   CREATE / EDIT / SAVE LEAD
════════════════════════════════════════════ */
window.openCreate=async function(){
  editingLeadId=null;invSet=new Set();dupClientId=null;
  ge('ml-t').textContent='Create Lead';ge('ml-sb').textContent='Create Lead';
  ['f-client','f-contact','f-origin','f-dest','f-cargo','f-notes'].forEach(id=>{if(ge(id))ge(id).value='';});
  ['f-cont','f-mode','f-src'].forEach(id=>{if(ge(id))ge(id).value='';});
  ge('f-status').value='Submitted';ge('f-value').value='';
  ge('dup-warn').classList.remove('show');
  ge('client-suggest').classList.remove('open');
  const w=ge('inv-wrap');
  if(userProfile.role==='admin'){w.style.display='block';await loadUsers();buildInvGrid(allUsers.filter(u=>u.uid!==currentUser.uid));}
  else w.style.display='none';
  window.openM('m-lead');
};

window.editLead=function(id){
  const l=leads.find(x=>x.id===id);if(!l)return;
  editingLeadId=id;invSet=new Set(l.invitees||[]);
  ge('ml-t').textContent='Edit Lead';ge('ml-sb').textContent='Save Changes';
  ge('f-client').value=l.client;ge('f-contact').value=l.contact||'';
  ge('f-origin').value=l.origin;ge('f-dest').value=l.dest;
  ge('f-cargo').value=l.cargo||'';ge('f-cont').value=l.container||'';
  ge('f-mode').value=l.mode;ge('f-src').value=l.source;
  ge('f-status').value=l.status;ge('f-value').value=l.value||'';ge('f-notes').value=l.notes||'';
  ge('dup-warn').classList.remove('show');
  const w=ge('inv-wrap');
  if(userProfile.role==='admin'){w.style.display='block';loadUsers().then(()=>buildInvGrid(allUsers.filter(u=>u.name!==l.owner)));}
  else w.style.display='none';
  window.openM('m-lead');
};

function buildInvGrid(users){
  ge('inv-grid').innerHTML=users.map(u=>`<div class="inv-card ${invSet.has(u.name)?'sel':''}" id="ic-${u.uid}" onclick="window.toggleInv('${u.name}','${u.uid}')"><div class="inv-chk"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><div class="ic-av">${u.name[0]}</div><div class="ic-n">${u.name}</div><div class="ic-r">${u.role==='admin'?'Admin':'Executive'}</div></div>`).join('');
}
window.toggleInv=function(name,uid){
  if(invSet.has(name)){invSet.delete(name);ge('ic-'+uid)?.classList.remove('sel');}
  else{invSet.add(name);ge('ic-'+uid)?.classList.add('sel');}
};

window.saveLead=async function(){
  const client=val('f-client'),origin=val('f-origin'),dest=val('f-dest'),cargo=val('f-cargo'),mode=val('f-mode'),src=val('f-src');
  if(!client||!origin||!dest||!cargo||!mode||!src)return toast('Fill all required fields','err');
  
  // Extract @mentions from notes
  const notesText=val('f-notes');
  const mentionMatches=notesText.match(/@(\w+ ?\w+)/g)||[];
  const mentions=mentionMatches.map(m=>m.slice(1).trim()).filter(m=>allUsers.some(u=>u.name===m));

  const data={client,contact:val('f-contact'),origin,dest,cargo,container:val('f-cont'),mode,source:src,status:val('f-status')||'Submitted',value:Number(val('f-value'))||0,notes:notesText,invitees:[...invSet],mentions,lastActivity:now()};
  try{
    if(editingLeadId){
      const old=leads.find(x=>x.id===editingLeadId);
      const changes=[];
      if(old.status!==data.status)changes.push(`Status: ${old.status} → ${data.status}`);
      if(old.value!==data.value)changes.push(`Value: ${money(old.value)} → ${money(data.value)}`);
      await updateDoc(doc(db,'leads',editingLeadId),data);
      await writeAudit('Updated',editingLeadId,client,changes.length?changes.join(', '):'Details updated');
      toast('Lead updated');
    }else{
      const ref=await addDoc(collection(db,'leads'),{...data,owner:userProfile.name,ownerUid:currentUser.uid,quotes:[],callLogs:[],accessRequests:[],createdAt:serverTimestamp()});
      await writeAudit('Created',ref.id,client,`${origin} → ${dest} · ${mode} · ${money(data.value)}`);
      toast(invSet.size?`Lead created, shared with ${invSet.size} member(s)`:'Lead created');
    }
    window.closeM('m-lead');
  }catch(e){toast(e.message,'err');}
};

window.delLead=async function(id){
  const l=leads.find(x=>x.id===id);
  if(!confirm('Delete lead permanently?'))return;
  try{
    await writeAudit('Deleted',id,l?.client||'Lead','Permanently deleted');
    await deleteDoc(doc(db,'leads',id));
    toast('Lead deleted');
  }catch(e){toast(e.message,'err');}
};

/* ════════════════════════════════════════════
   VIEW LEAD DETAIL
════════════════════════════════════════════ */
window.viewLead=function(id){
  const l=leads.find(x=>x.id===id);if(!l)return;
  const ed=canEdit(l),req=(l.accessRequests||[]).find(r=>r.by===userProfile.name),cs=collabsOf(l);
  ge('md-t').textContent=l.client+' / '+(l.id?.slice(-8)||'—');
  let ban='';
  if(!ed&&!req)ban=`<div class="ban ban-amber">View-only. <button class="btn btn-sm btn-outline" onclick="window.closeM('m-detail');setTimeout(()=>window.openReqAccess('${l.id}'),100)">Request Edit Access</button></div>`;
  else if(req?.status==='pending'&&!ed)ban=`<div class="ban ban-blue">Access request pending.</div>`;
  else if(ed&&l.ownerUid!==currentUser.uid)ban=`<div class="ban ban-green">You have edit access.</div>`;

  // Call logs timeline
  const callLog=(l.callLogs||[]);
  const activityHtml=callLog.length?`<div class="sec-lbl">Call Activity</div><div class="activity-timeline">${callLog.map(c=>`<div class="at-row"><div class="at-dot" style="border-color:${c.outcome==='Reached'?'var(--green)':c.outcome==='Voicemail'?'var(--amber)':'var(--t3)'}"><svg viewBox="0 0 24 24" stroke="${c.outcome==='Reached'?'var(--green)':c.outcome==='Voicemail'?'var(--amber)':'var(--t3)'}"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 11.5a19.79 19.79 0 01-3.07-8.67A2 2 0 012 .84h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.91 8.09a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0121.16 15z"/></svg></div><div class="at-body"><div class="at-text"><b>${c.outcome}</b>${c.notes?' — '+c.notes:''}</div><div class="at-meta">By ${c.by} · ${timeAgo(c.ts)}</div></div></div>`).join('')}</div>`:'';

  ge('md-b').innerHTML=`${ban}<div class="dg"><div class="db"><div class="df"><div class="dk">Client</div><div class="dv">${l.client}</div></div><div class="df"><div class="dk">Contact</div><div class="dv">${l.contact||'—'}</div></div><div class="df"><div class="dk">Cargo</div><div class="dv">${l.cargo||'—'}</div></div><div class="df"><div class="dk">Container</div><div class="dv">${l.container||'—'}</div></div></div><div class="db"><div class="df"><div class="dk">Route</div><div class="dv">${l.origin} → ${l.dest}</div></div><div class="df"><div class="dk">Mode</div><div class="dv">${bdg(l.mode,MC[l.mode])}</div></div><div class="df"><div class="dk">Status</div><div class="dv">${bdg(l.status,SC[l.status])}</div></div><div class="df"><div class="dk">Est. Value</div><div class="dv mono" style="color:var(--accent)">${money(l.value)}</div></div></div></div><div class="db" style="margin-bottom:.82rem"><div class="df"><div class="dk">Source</div><div class="dv">${l.source}</div></div><div class="df"><div class="dk">Owner</div><div class="dv">${l.owner}</div></div><div class="df"><div class="dk">Last Activity</div><div class="dv">${timeAgo(l.lastActivity)}</div></div>${cs.length?`<div class="df"><div class="dk">Collaborators</div><div class="dv">${cs.map(c=>`<span class="chip">${c.name}</span>`).join(' ')}</div></div>`:''} ${l.notes?`<div class="df"><div class="dk">Notes</div><div class="dv" style="color:var(--t2)">${l.notes.replace(/@(\w+ ?\w+)/g,'<span class="mention-highlight">@$1</span>')}</div></div>`:''}</div>
  <div style="font-size:.78rem;font-weight:700;margin-bottom:.48rem">Quotes (${(l.quotes||[]).length})</div>${(l.quotes||[]).length?(l.quotes||[]).map(q=>`<div class="qi"><div class="qi-top"><div class="qi-p">${q.cur} ${Number(q.val).toLocaleString('en-IN')}</div>${bdg('Submitted','bs')}</div><div class="qi-m">ETA: ${q.eta||'—'} · By: ${q.by} · ${q.date}</div>${q.notes?`<div style="font-size:.67rem;color:var(--t3);margin-top:.2rem">${q.notes}</div>`:''}</div>`).join(''):emptyRow('No quotes yet.')}
  ${activityHtml}
  ${ed?`<div style="display:flex;gap:.38rem;margin-top:.72rem;flex-wrap:wrap"><button class="btn btn-outline btn-sm" onclick="window.closeM('m-detail');setTimeout(()=>window.openQuote('${l.id}'),120)">+ Quote</button><button class="btn btn-ghost btn-sm" onclick="window.closeM('m-detail');setTimeout(()=>window.editLead('${l.id}'),120)">Edit</button><button class="btn btn-ghost btn-sm" onclick="window.openCallLog('${l.id}')">Log Call</button><button class="btn btn-ghost btn-sm" onclick="window.closeM('m-detail');setTimeout(()=>window.openFollowUp('${l.id}'),120)">Schedule Follow-up</button><button class="btn btn-ghost btn-sm" onclick="window.sendWhatsApp('${l.id}')">WhatsApp</button><button class="btn btn-outline btn-sm" onclick="window.openDocFromDetail('${l.id}')">📎 Attach Docs${(l.documents||[]).length?` (${l.documents.length})`:''}</button>${l.ownerUid===currentUser.uid||userProfile.role==='admin'?`<button class="btn btn-ghost btn-sm" onclick="window.closeM('m-detail');setTimeout(()=>window.openShare('${l.id}'),120)">Manage Access ↗</button>`:''}</div>`:''}</div>`;
  window.openM('m-detail');
};

/* ════════════════════════════════════════════
   QUOTE / REQUEST / SHARE — same as before
════════════════════════════════════════════ */
window.openQuote=function(id){quotingLeadId=id;['q-val','q-eta','q-notes'].forEach(f=>ge(f).value='');ge('q-cur').value='INR';window.openM('m-quote');};
window.saveQuote=async function(){
  const v=val('q-val');if(!v)return toast('Enter a value','err');
  const l=leads.find(x=>x.id===quotingLeadId);if(!l)return;
  const q={val:Number(v),cur:val('q-cur')||'INR',eta:val('q-eta'),notes:val('q-notes'),by:userProfile.name,date:today()};
  try{
    await updateDoc(doc(db,'leads',quotingLeadId),{quotes:arrayUnion(q),status:l.status==='Submitted'?'Quoted':l.status,lastActivity:now()});
    await writeAudit('Quote Added',quotingLeadId,l.client,`${q.cur} ${Number(q.val).toLocaleString('en-IN')} by ${userProfile.name}`);
    window.closeM('m-quote');toast('Quote submitted');
  }catch(e){toast(e.message,'err');}
};

window.openReqAccess=function(id){reqLeadId=id;ge('req-r').value='';window.openM('m-req');};
window.submitReq=async function(){
  const reason=val('req-r');if(!reason)return toast('Provide a reason','err');
  const l=leads.find(x=>x.id===reqLeadId);if(!l)return;
  if((l.accessRequests||[]).some(r=>r.by===userProfile.name&&r.status==='pending'))return toast('Request already pending','err');
  try{await updateDoc(doc(db,'leads',reqLeadId),{accessRequests:arrayUnion({by:userProfile.name,uid:currentUser.uid,reason,status:'pending',date:today()})});window.closeM('m-req');toast('Request sent to '+l.owner,'info');}catch(e){toast(e.message,'err');}
};

window.resolveReq=async function(leadId,by,status){
  const l=leads.find(x=>x.id===leadId);if(!l)return;
  const req=(l.accessRequests||[]).find(r=>r.by===by);if(!req)return;
  try{
    await updateDoc(doc(db,'leads',leadId),{accessRequests:arrayRemove(req)});
    await updateDoc(doc(db,'leads',leadId),{accessRequests:arrayUnion({...req,status})});
    if(status==='approved'&&!(l.invitees||[]).includes(by))await updateDoc(doc(db,'leads',leadId),{invitees:arrayUnion(by)});
    toast(status==='approved'?`Access granted to ${by}`:`Request from ${by} rejected`,status==='approved'?'ok':'err');
    renderShareModal();renderNotifs();refreshDots();
  }catch(e){toast(e.message,'err');}
};

window.openShare=function(id){shareLeadId=id;renderShareModal();window.openM('m-share');};
async function renderShareModal(){
  const l=leads.find(x=>x.id===shareLeadId);if(!l)return;
  const cs=collabsOf(l),pend=(l.accessRequests||[]).filter(r=>r.status==='pending');
  await loadUsers();
  const already=[l.owner,...(l.invitees||[]),...(l.accessRequests||[]).filter(r=>r.status==='approved').map(r=>r.by)];
  const avail=allUsers.filter(u=>!already.includes(u.name)&&u.uid!==currentUser.uid);
  ge('ms-b').innerHTML=`<div class="share-box"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.45rem"><span style="font-size:.75rem;font-weight:700;color:var(--accent)">Lead Share</span><span class="mono" style="background:var(--white);border:1px solid var(--ab);padding:.15rem .45rem;border-radius:4px">${l.id?.slice(-8)||'—'}</span></div><div style="font-size:.71rem;color:var(--t2)"><b>${l.client}</b> · ${l.origin} → ${l.dest} · Owner: <b>${l.owner}</b></div></div>
  <div class="sec-lbl">Collaborators (${cs.length})</div>${cs.length?`<div style="display:flex;flex-wrap:wrap;gap:.32rem;margin-bottom:.88rem">${cs.map(c=>`<div class="collab-chip"><div class="av" style="width:18px;height:18px;font-size:.52rem;border-radius:3px">${c.name[0]}</div><span>${c.name}</span>${(userProfile.role==='admin'||l.ownerUid===currentUser.uid)?`<button onclick="window.removeCollab('${l.id}','${c.name}')" class="rc-x">&times;</button>`:''}</div>`).join('')}</div>`:`<div style="font-size:.73rem;color:var(--t3);margin-bottom:.82rem">No collaborators yet.</div>`}
  ${userProfile.role==='admin'&&avail.length?`<div class="sec-lbl">Quick Invite</div><div class="inv-grid" id="qi-grid">${avail.map(u=>`<div class="inv-card" data-emp="${u.name}" onclick="this.classList.toggle('sel')"><div class="inv-chk"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><div class="ic-av">${u.name[0]}</div><div class="ic-n">${u.name}</div></div>`).join('')}</div><div style="display:flex;justify-content:flex-end;margin-top:.52rem"><button class="btn btn-sm btn-blue" onclick="window.applyQuickInvite('${l.id}')">Add Selected</button></div>`:''}
  <div class="sec-lbl">Pending Requests (${pend.length})</div>${pend.length?pend.map(r=>`<div class="nc urgent" style="margin-bottom:.42rem"><div class="ni ni-amber"><svg viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg></div><div class="nb"><div class="nb-t"><b>${r.by}</b> wants edit access</div><div class="nb-m">"${r.reason||'No reason'}" · ${r.date}</div><div class="nb-a"><button class="btn btn-sm btn-green" onclick="window.resolveReq('${l.id}','${r.by}','approved')">Approve</button><button class="btn btn-sm btn-red" onclick="window.resolveReq('${l.id}','${r.by}','rejected')">Reject</button></div></div></div>`).join(''):`<div style="font-size:.73rem;color:var(--t3)">No pending requests.</div>`}`;
}

window.removeCollab=async function(leadId,emp){
  try{
    await updateDoc(doc(db,'leads',leadId),{invitees:arrayRemove(emp)});
    const l=leads.find(x=>x.id===leadId);
    if(l){const r=(l.accessRequests||[]).find(x=>x.by===emp);if(r)await updateDoc(doc(db,'leads',leadId),{accessRequests:arrayRemove(r)});}
    toast(emp+' removed');renderShareModal();
  }catch(e){toast(e.message,'err');}
};

window.applyQuickInvite=async function(leadId){
  const sel=Array.from(document.querySelectorAll('#qi-grid .inv-card.sel')).map(el=>el.dataset.emp);
  if(!sel.length)return toast('Select employees to invite','err');
  try{await updateDoc(doc(db,'leads',leadId),{invitees:arrayUnion(...sel)});toast(`Invited ${sel.length} member(s)`);renderShareModal();}catch(e){toast(e.message,'err');}
};

/* ════════════════════════════════════════════
   MODAL HELPERS
════════════════════════════════════════════ */
window.openM=id=>ge(id)?.classList.add('open');
window.closeM=id=>ge(id)?.classList.remove('open');
document.querySelectorAll('.ov').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

window.toast=function(m,t='ok'){
  const el=ge('toast');ge('tm').textContent=m;
  el.className=`toast ${t} show`;setTimeout(()=>el.classList.remove('show'),2800);
};
</script>
</body>
</html>
