<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wort — Logistics Management</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, updateProfile
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore, collection, doc, setDoc, getDoc, getDocs,
  addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp,
  arrayUnion, arrayRemove
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyDtrhy6HsZLIPPS0_cX0fVYVI4l6HnxnXg",
    authDomain: "wort-b848f.firebaseapp.com",
    projectId: "wort-b848f",
    storageBucket: "wort-b848f.firebasestorage.app",
    messagingSenderId: "371737860780",
    appId: "1:371737860780:web:ae8f0a088535b6d088dd09"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// ── GLOBALS ──
let currentUser = null, userProfile = null;
let leads = [], allUsers = [];
let unsubLeads = null;
let editingLeadId = null, quotingLeadId = null, reqLeadId = null, shareLeadId = null;
let invSet = new Set();

// ── HELPERS ──
const ge = id => document.getElementById(id);
const v  = id => (ge(id)?.value||'').trim();
const today = () => new Date().toISOString().split('T')[0];
const money = n => n ? '₹'+Number(n).toLocaleString('en-IN') : '—';
const bdg = (t,c) => `<span class="bdg ${c}">${t}</span>`;
const empty = m => `<div class="empty"><div>${m||'No records.'}</div></div>`;

const SC  = {Submitted:'bs',Quoted:'bq',Accepted:'ba',Completed:'bc',Lost:'bl'};
const MC  = {Air:'bair',Sea:'bsea',Road:'broad',Multimodal:'bmulti'};
const SCC = {Submitted:'#2563eb',Quoted:'#d97706',Accepted:'#7c3aed',Completed:'#059669',Lost:'#dc2626'};

function friendlyErr(e) {
  if (e.code === 'auth/operation-not-allowed') return "Email/Password sign-in is disabled in Firebase Console!";
  return ({
    'auth/user-not-found':'No account with that email',
    'auth/wrong-password':'Incorrect password',
    'auth/email-already-in-use':'Email already registered',
    'auth/invalid-credential':'Incorrect email or password',
  })[e.code] || e.message;
}

function showScreen(s) {
  ge('loading-screen').style.display = s==='loading'?'flex':'none';
  ge('login-screen').style.display   = s==='login'  ?'flex':'none';
  ge('app-shell').style.display      = s==='app'    ?'flex':'none';
}

// ── AUTH ──
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    try {
        const snap = await getDoc(doc(db,'users',user.uid));
        if (snap.exists()) { 
            userProfile = snap.data(); 
            enterApp(); 
        } else { 
            // If user is authenticated but no profile exists in Firestore
            await signOut(auth); 
            showScreen('login'); 
            toast("Account setup incomplete. Please register again.", "err");
        }
    } catch(err) {
        console.error("Firestore Error:", err);
        showScreen('login');
    }
  } else {
    currentUser=null; userProfile=null;
    if(unsubLeads){unsubLeads();unsubLeads=null;}
    showScreen('login');
  }
});

window.doLogin = async function() {
  const [email,pass]=[v('login-email'),v('login-pass')];
  if(!email||!pass) return toast('Enter email and password','err');
  const btn=ge('login-btn'); btn.disabled=true; btn.textContent='Signing in…';
  try { await signInWithEmailAndPassword(auth,email,pass); }
  catch(e){ toast(friendlyErr(e),'err'); btn.disabled=false; btn.textContent='Sign In →'; }
};

window.doRegister = async function() {
  const [name,email,pass]=[v('reg-name'),v('reg-email'),v('reg-pass')];
  const role = window._regRole;
  if(!name||!email||!pass||!role) return toast('Fill all fields and select a role','err');
  if(pass.length<6) return toast('Password needs 6+ chars','err');
  
  const btn=ge('reg-btn'); btn.disabled=true; btn.textContent='Creating…';
  try {
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    // Critical: Storing the profile so the app can move past the loading screen
    await setDoc(doc(db,'users',cred.user.uid),{
        name,
        email,
        role,
        createdAt: serverTimestamp()
    });
    toast('Welcome, '+name+'!');
  } catch(e){ 
      toast(friendlyErr(e),'err'); 
      btn.disabled=false; 
      btn.textContent='Create Account →'; 
  }
};

window.doLogout = async function() {
  if(unsubLeads){unsubLeads();unsubLeads=null;}
  await signOut(auth);
};

window._regRole = null;
window.pickRole = function(r) {
  window._regRole=r;
  document.querySelectorAll('.rb').forEach(b=>b.classList.remove('sel'));
  ge('rb-'+r).classList.add('sel');
};
window.showReg  = ()=>{ ge('lp').style.display='none';ge('rp').style.display='block'; };
window.showLogin= ()=>{ ge('lp').style.display='block';ge('rp').style.display='none'; };

function enterApp() {
  const {name,role}=userProfile;
  ge('uav').textContent=name[0].toUpperCase();
  ge('uname').textContent=name;
  ge('urole').textContent=role==='admin'?'Administrator':'Employee';
  ge('sb-tag').textContent=role==='admin'?'Admin':'Employee';
  buildNav();
  subscribeLeads();
  showScreen('app');
}

function subscribeLeads() {
  if(unsubLeads)unsubLeads();
  unsubLeads = onSnapshot(
    query(collection(db,'leads'),orderBy('createdAt','desc')),
    snap => {
      leads = snap.docs.map(d=>({id:d.id,...d.data()}));
      refreshCurrentPage();
    }
  );
}

// ... Rest of your Navigation and Lead CRUD functions follow ...

window.ge = ge;
window.toast = function(m,t='ok') {
  const e=ge('toast'); ge('tm').textContent=m;
  e.className=`toast ${t} show`; setTimeout(()=>e.classList.remove('show'),2800);
};
</script>

<style>
/* ... Your Existing CSS (Keep it all) ... */
</style>
</head>
<body>
</body>
</html>
